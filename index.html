<!doctype html>

<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>TPN Calculator</title>
    <script src="/_sdk/element_sdk.js"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Sarabun','Noto Sans Thai',Arial,sans-serif;
            margin:0;
            padding:20px;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100%;
        }
        .container {
            max-width:800px;
            margin:0 auto;
            background:white;
            border-radius:16px;
            box-shadow:0 20px 40px rgba(0,0,0,0.1);
            overflow:hidden;
            position:relative;
        }
        .clear-btn {
            position:absolute;
            top:20px;
            right:20px;
            background:#ef4444;
            color:white;
            border:none;
            padding:10px 20px;
            font-size:0.9em;
            border-radius:8px;
            cursor:pointer;
            box-shadow:0 2px 8px rgba(239,68,68,0.3);
            transition:all 0.3s;
            font-weight:600;
            z-index:10;
        }
        .clear-btn:hover {
            background:#dc2626;
            transform:translateY(-2px);
            box-shadow:0 4px 12px rgba(239,68,68,0.5);
        }
        .clear-btn:active {
            transform:translateY(0);
        }
        .header {
            background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
            color:white;
            padding:30px;
            padding-top:60px;
            text-align:center;
        }
        .header h1 {
            margin:0 0 10px 0;
            font-size:2.2em;
            font-weight:600;
        }
        .header p {
            margin:0;
            font-size:1.1em;
            opacity:.9;
        }
        .content {
            padding:30px;
        }
        .section {
            background:#f8fafc;
            border-radius:12px;
            padding:25px;
            margin-bottom:25px;
            border-left:4px solid #4facfe;
        }
        .section h2 {
            color:#2d3748;
            margin:0 0 20px 0;
            font-size:1.4em;
            font-weight:600;
        }
        .input-group {
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:20px;
            margin-bottom:20px;
        }
        .input-field {
            display:flex;
            flex-direction:column;
        }
        .input-field label {
            color:#4a5568;
            font-weight:500;
            margin-bottom:8px;
            font-size:.95em;
        }
        .input-with-unit {
            display:flex;
            align-items:center;
            position:relative;
        }
        .input-field input {
            padding:12px 16px;
            border:2px solid #e2e8f0;
            border-radius:8px;
            font-size:1em;
            transition:all .3s ease;
            background:white;
            flex:1;
            padding-right:60px;
            -webkit-appearance:none;
            -moz-appearance:textfield;
        }
        .input-field input[type="date"] {
            padding:12px 16px;
            padding-right:16px;
        }
        .input-field input::-webkit-outer-spin-button,
        .input-field input::-webkit-inner-spin-button {
            -webkit-appearance:none;
            margin:0;
        }
        .input-field input:focus {
            outline:none;
            border-color:#4facfe;
            box-shadow:0 0 0 3px rgba(79,172,254,.1);
        }
        .unit {
            position:absolute;
            right:16px;
            color:#718096;
            font-size:.9em;
            font-weight:500;
            pointer-events:none;
            background:white;
            padding-left:8px;
        }
        .date-warning {
            color:#dc2626;
            font-weight:700;
            font-size:0.85em;
            margin-top:6px;
        }

    /* Product Selection Styles */
    .product-selection {
        margin-top:20px;
        padding-top:20px;
        border-top:2px solid #e2e8f0;
    }
    .product-selection h3 {
        color:#2d3748;
        margin:0 0 15px 0;
        font-size:1.05em;
        font-weight:600;
    }
    .product-options {
        display:flex;
        flex-direction:column;
        gap:10px;
        margin-bottom:20px;
    }
    .product-option {
        display:flex;
        align-items:center;
        padding:12px 15px;
        border-radius:8px;
        border:2px solid #e2e8f0;
        background:white;
        cursor:pointer;
        transition:all .3s ease;
    }
    .product-option:hover {
        background:#f0f9ff;
        border-color:#4facfe;
    }
    .product-option.selected {
        background:#e0f2fe;
        border-color:#0284c7;
        box-shadow:0 2px 8px rgba(2,132,199,0.2);
    }
    .product-option input[type="radio"] {
        margin-right:12px;
        transform:scale(1.2);
        cursor:pointer;
        accent-color:#4facfe;
    }
    .product-option-label {
        flex:1;
        cursor:pointer;
    }
    .product-name {
        font-weight:600;
        color:#2d3748;
        font-size:0.95em;
    }
    .product-info {
        font-size:0.85em;
        color:#64748b;
        margin-top:2px;
    }
    
    /* TPN Table */
    .tpn-table {
        background:white;
        border-radius:12px;
        overflow:hidden;
        margin-top:20px;
        border:2px solid #e2e8f0;
        width:100%;
        display:table;
        table-layout:fixed;
    }
    .table-header {
        display:table-row;
        background:#f8fafc;
        border-bottom:2px solid #e2e8f0;
    }
    .table-row {
        display:table-row;
        border-bottom:1px solid #f1f5f9;
    }
    .table-row:last-child {
        border-bottom:none;
    }
    .table-cell {
        display:table-cell;
        padding:10px 8px;
        text-align:center;
        vertical-align:middle;
        min-height:50px;
        box-sizing:border-box;
        border-right:1px solid #f1f5f9;
    }
    .table-cell:last-child {
        border-right:none;
    }
    .header-cell {
        font-weight:600;
        color:#2d3748;
        background:#f8fafc;
        font-size:.9em;
        width:25%;
    }
    .component-cell {
        font-weight:500;
        color:#2d3748;
        text-align:left;
        padding-left:16px;
        font-size:.95em;
        width:25%;
    }
    .result-cell {
        font-weight:600;
        color:#0369a1;
        background:#f0f9ff;
        font-size:.85em;
        text-align:center;
        width:25%;
    }
    .result-cell.volume-yellow {
        background:#fef3c7;
        color:#92400e;
        border:1px solid #fcd34d;
    }
    .result-cell.osmol-purple {
        background:#f3e8ff;
        color:#7c3aed;
        border:1px solid #c4b5fd;
    }
    
    /* GIR Display */
    .gir-display {
        display:flex;
        justify-content:space-between;
        align-items:center;
        background:white;
        border-radius:8px;
        padding:15px;
        margin-top:15px;
        border:2px solid #e2e8f0;
    }
    .gir-label {
        font-weight:600;
        color:#be185d;
    }
    .calc-result {
        background:#f0f9ff;
        padding:8px 12px;
        border-radius:6px;
        text-align:center;
        font-weight:600;
        color:#0369a1;
        border:1px solid #bae6fd;
    }
    .calc-result.gir-pink {
        background:#fce7f3;
        color:#be185d;
        border:1px solid #f9a8d4;
    }
    
    /* Calculation Section */
    .calculation-section {
        background:white;
        border-radius:12px;
        padding:20px;
        margin-top:15px;
        border:2px solid #e2e8f0;
    }
    .calc-row {
        display:grid;
        grid-template-columns:2fr 1fr 1fr;
        gap:15px;
        align-items:center;
        padding:12px 0;
        border-bottom:1px solid #f1f5f9;
    }
    .calc-row:last-child {
        border-bottom:none;
    }
    .calc-label {
        font-weight:500;
        color:#2d3748;
    }
    .calc-label.bold {
        font-weight:700;
        color:#1e293b;
    }
    
    /* Total Section */
    .total-section {
        background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        color:white;
        border-radius:12px;
        padding:25px;
        text-align:center;
        margin-top:25px;
    }
    .total-section h2 {
        margin:0 0 15px 0;
        font-size:1.6em;
    }
    .total-calories {
        font-size:2.5em;
        font-weight:700;
        margin:10px 0;
    }
    
    /* Route Selection */
    .route-selection {
        margin-top:20px;
    }
    .route-selection h3 {
        color:#2d3748;
        margin:0 0 15px 0;
        font-size:1.1em;
        font-weight:600;
    }
    .route-options {
        display:flex;
        gap:15px;
    }
    .route-option {
        flex:1;
        display:flex;
        align-items:center;
        justify-content:center;
        padding:15px;
        border-radius:8px;
        border:2px solid #e2e8f0;
        background:#f8fafc;
        cursor:pointer;
        transition:all .3s ease;
    }
    .route-option:hover {
        background:#f0f9ff;
        border-color:#4facfe;
    }
    .route-option input[type="radio"] {
        margin-right:10px;
        transform:scale(1.3);
        cursor:pointer;
    }
    .route-option label {
        font-weight:500;
        color:#2d3748;
        cursor:pointer;
        font-size:1em;
    }
    .route-option input[type="radio"]:checked + label {
        color:#4facfe;
        font-weight:600;
    }
    
    /* Electrolyte Styles */
    .electrolyte-item {
        background:white;
        border-radius:8px;
        padding:20px;
        margin-bottom:15px;
        border:2px solid #e2e8f0;
    }
    .electrolyte-header {
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:15px;
        margin-bottom:15px;
    }
    .electrolyte-input {
        display:flex;
        flex-direction:column;
    }
    .electrolyte-input label {
        color:#4a5568;
        font-weight:600;
        margin-bottom:8px;
        font-size:1em;
    }
    .electrolyte-input input {
        padding:12px 16px;
        border:2px solid #e2e8f0;
        border-radius:8px;
        font-size:1em;
        transition:all .3s ease;
        background:white;
        -webkit-appearance:none;
        -moz-appearance:textfield;
    }
    .electrolyte-input input::-webkit-outer-spin-button,
    .electrolyte-input input::-webkit-inner-spin-button {
        -webkit-appearance:none;
        margin:0;
    }
    .electrolyte-input input:focus {
        outline:none;
        border-color:#4facfe;
        box-shadow:0 0 0 3px rgba(79,172,254,.1);
    }
    .electrolyte-result {
        background:#f0fdf4;
        border:2px solid #86efac;
        border-radius:8px;
        padding:12px;
        text-align:center;
    }
    .electrolyte-result-label {
        font-size:0.85em;
        color:#166534;
        font-weight:500;
        margin-bottom:4px;
    }
    .electrolyte-result-value {
        font-size:1.3em;
        color:#166534;
        font-weight:700;
    }
    
    /* Source Selection */
    .source-selection {
        margin-top:15px;
        padding-top:15px;
        border-top:1px solid #e2e8f0;
    }
    .source-selection h4 {
        margin:0 0 12px 0;
        color:#2d3748;
        font-size:0.95em;
        font-weight:600;
    }
    .source-option {
        display:flex;
        align-items:center;
        padding:10px;
        margin-bottom:8px;
        border-radius:6px;
        background:#f8fafc;
        transition:all .2s ease;
        cursor:pointer;
    }
    .source-option:hover {
        background:#f0f9ff;
    }
    .source-option input[type="radio"] {
        margin-right:12px;
        transform:scale(1.3);
        cursor:pointer;
    }
    .source-option-label {
        flex:1;
        font-weight:500;
        color:#2d3748;
    }
    .source-option-value {
        background:#dbeafe;
        color:#1e40af;
        padding:6px 12px;
        border-radius:4px;
        font-weight:600;
        font-size:0.9em;
        min-width:60px;
        text-align:center;
    }
    
    /* Frequency Selection */
    .frequency-selection {
        margin-top:15px;
        padding-top:15px;
        border-top:1px solid #e2e8f0;
    }
    .frequency-selection h4 {
        margin:0 0 12px 0;
        color:#2d3748;
        font-size:0.95em;
        font-weight:600;
    }
    .frequency-option {
        display:flex;
        align-items:center;
        padding:10px;
        margin-bottom:8px;
        border-radius:6px;
        background:#f8fafc;
        transition:all .2s ease;
        cursor:pointer;
    }
    .frequency-option:hover {
        background:#f0f9ff;
    }
    .frequency-option input[type="radio"] {
        margin-right:12px;
        transform:scale(1.3);
        cursor:pointer;
    }
    .frequency-option-label {
        flex:1;
        font-weight:500;
        color:#2d3748;
    }
    .day-selector {
        margin-left:30px;
        margin-top:8px;
        display:none;
    }
    .day-selector select {
        padding:8px 12px;
        border:2px solid #e2e8f0;
        border-radius:6px;
        font-size:0.95em;
    }
    
    /* Submit Button */
    .submit-section {
        text-align:center;
        margin-top:30px;
    }
    .submit-btn {
        background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        color:white;
        border:none;
        padding:18px 50px;
        font-size:1.2em;
        border-radius:50px;
        cursor:pointer;
        box-shadow:0 4px 15px rgba(102,126,234,0.4);
        transition:all 0.3s;
        font-weight:600;
    }
    .submit-btn:hover {
        transform:translateY(-2px);
        box-shadow:0 6px 20px rgba(102,126,234,0.6);
    }
    .submit-btn:active {
        transform:translateY(0);
    }
    
    /* Responsive Design */
    @media (max-width:768px) {
        .clear-btn {
            top:10px;
            right:10px;
            padding:8px 16px;
            font-size:0.85em;
        }
        .header {
            padding-top:50px;
        }
        .input-group {
            grid-template-columns:1fr;
        }
        .route-options {
            flex-direction:column;
        }
        .electrolyte-header {
            grid-template-columns:1fr;
        }
        .tpn-table {
            font-size:.85em;
            border-radius:8px;
        }
        .table-cell {
            padding:8px 4px;
            min-height:45px;
        }
        .component-cell {
            padding-left:8px;
            font-size:.85em;
        }
        .result-cell {
            font-size:.8em;
        }
        .header-cell {
            font-size:.8em;
            padding:8px 4px;
        }
        .gir-display {
            flex-direction:column;
            gap:10px;
            text-align:center;
        }
        .container {
            margin:10px;
            border-radius:12px;
        }
        .content {
            padding:20px;
        }
        .total-section {
            padding:20px;
        }
        .total-section h2 {
            font-size:1.3em;
        }
        .total-calories {
            font-size:2em;
        }
        .product-options {
            gap:8px;
        }
        .product-option {
            padding:10px 12px;
        }
    }
</style>
<style>
    @view-transition {
        navigation: auto;
    }
</style>
<script src="/_sdk/data_sdk.js" type="text/javascript"></script>
<script src="https://cdn.tailwindcss.com" type="text/javascript"></script>


</head>

<body>
    <main class="container">
        <!-- Clear Data Button -->
        <button id="clearBtn" class="clear-btn">üóëÔ∏è Clear data</button>


    <!-- Header -->
    <header class="header">
        <h1 id="app-title">TPN Calculator</h1>
        <p id="subtitle">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å</p>
    </header>
    
    <div class="content">
        <!-- Order Date Section -->
        <section class="section">
            <h2>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Order TPN</h2>
            <div class="input-group">
                <div class="input-field">
                    <label for="order-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <div class="input-with-unit">
                        <input type="date" id="order-date" style="padding-right:16px;">
                    </div>
                    <div class="date-warning">‚ö†Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                </div>
                <div class="input-field"><!-- spacer --></div>
            </div>
        </section>
        
        <!-- Patient Info Section -->
        <section class="section">
            <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
            
            <!-- Camera Section for Patient Sticker -->
            <div style="margin-bottom: 20px;">
                <h3 style="color: #2d3748; font-size: 1.05em; font-weight: 600; margin-bottom: 12px;">
                    üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ Patient Sticker
                </h3>
                
                <!-- Camera Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button type="button" id="openCameraBtn" class="btn" 
                            style="background: #10b981; padding: 12px 20px; border-radius: 8px; 
                                   display: inline-flex; align-items: center; gap: 8px; 
                                   box-shadow: 0 4px 12px rgba(16,185,129,0.4); color: white; 
                                   border: none; cursor: pointer; font-weight: 600;">
                        üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                    </button>
                    <button type="button" id="clearStickerBtn" class="btn" 
                            style="background: #ef4444; padding: 12px 20px; border-radius: 8px; 
                                   display: none; box-shadow: 0 4px 12px rgba(239,68,68,0.4); 
                                   color: white; border: none; cursor: pointer; font-weight: 600;">
                        üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏π‡∏õ
                    </button>
                </div>
                
                <!-- Sticker Preview -->
                <div id="stickerPreviewContainer" 
                     style="display: none; border: 2px dashed #4facfe; border-radius: 8px; 
                            padding: 15px; background: #f0f9ff; text-align: center;">
                    <p style="margin-bottom: 10px; font-weight: 600; color: #0369a1;">
                        ‚úÖ ‡∏£‡∏π‡∏õ Patient Sticker:
                    </p>
                    <img id="stickerPreview" src="" alt="Patient Sticker" 
                         style="max-width: 200px; max-height: 160px; border: 2px solid #e2e8f0; 
                                border-radius: 4px; background: white;
                                image-rendering: -webkit-optimize-contrast;
                                image-rendering: crisp-edges;">
                </div>
                
                <!-- Camera Modal -->
                <div id="cameraModal" 
                     style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
                            z-index: 9999; justify-content: center; align-items: center; padding: 20px;">
                    <div style="background: white; border-radius: 12px; padding: 20px; 
                                max-width: 90%; max-height: 90%; overflow: auto;">
                        <h3 style="margin-bottom: 15px; text-align: center; color: #2d3748;">
                            üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ Patient Sticker
                        </h3>
                        <p style="text-align: center; color: #64748b; margin-bottom: 15px; font-size: 0.9em;">
                            ‡∏ß‡∏≤‡∏á‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                        </p>
                        
                        <!-- Camera Frame (5cm x 3cm) -->
                        <div id="cameraFrame" 
                             style="width: 5cm; height: 3cm; border: 2px solid #e2e8f0; 
                                    border-radius: 8px; margin: 0 auto 15px auto; position: relative; 
                                    overflow: hidden; background: #000;">
                            <video id="cameraVideo" autoplay playsinline 
                                   style="position: absolute; top: 50%; left: 50%; 
                                          transform: translate(-50%, -50%); min-width: 100%; 
                                          min-height: 100%; object-fit: cover;">
                            </video>
                        </div>
                        
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                        
                        <!-- Camera Action Buttons -->
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button type="button" id="captureBtn" class="btn" 
                                    style="background: #10b981; padding: 12px 24px; border-radius: 8px; 
                                           font-weight: 600; color: white; border: none; cursor: pointer;">
                                üì∑ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                            </button>
                            <button type="button" id="closeCameraBtn" class="btn secondary" 
                                    style="padding: 12px 24px; border-radius: 8px; font-weight: 600; 
                                           background: #6b7280; color: white; border: none; cursor: pointer;">
                                ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Manual Input Section (Collapsible) -->
            <div style="margin-top: 20px; border-top: 1px solid #e2e8f0; padding-top: 15px;">
                <button type="button" id="toggleManualInputBtn" 
                        style="background: #f8fafc; border: 2px solid #e2e8f0; padding: 10px 16px; 
                               border-radius: 8px; cursor: pointer; font-weight: 600; color: #4a5568; 
                               width: 100%; text-align: left; display: flex; justify-content: space-between; 
                               align-items: center; transition: all 0.3s; 
                               font-family: 'Sarabun', 'Noto Sans Thai', Arial, sans-serif;">
                    <span>üìù ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ Sticker)</span>
                    <span id="toggleIcon" style="font-size: 0.8em;">‚ñº</span>
                </button>
                
                <div id="manualInputSection" 
                     style="display: none; margin-top: 15px; padding: 15px; background: #f8fafc; 
                            border-radius: 8px; border: 2px solid #e2e8f0;">
                    <div class="input-group">
                        <div class="input-field">
                            <label for="patient-hn">HN</label>
                            <div class="input-with-unit">
                                <input type="text" id="patient-hn" placeholder="‡∏Å‡∏£‡∏≠‡∏Å HN" 
                                       style="padding-right:16px;">
                            </div>
                        </div>
                        <div class="input-field">
                            <label for="patient-name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <div class="input-with-unit">
                                <input type="text" id="patient-name" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" 
                                       style="padding-right:16px;">
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="patient-ward">Ward</label>
                            <div class="input-with-unit">
                                <input type="text" id="patient-ward" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Ward" 
                                       style="padding-right:16px;">
                            </div>
                        </div>
                        <div class="input-field"><!-- spacer --></div>
                    </div>
                </div>
            </div>
            
            <!-- Route Selection -->
            <div class="route-selection">
                <h3>Route ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ TPN</h3>
                <div class="route-options">
                    <label class="route-option">
                        <input type="radio" name="tpn-route" value="central" id="route-central" checked />
                        <label for="route-central">Central Line</label>
                    </label>
                    <label class="route-option">
                        <input type="radio" name="tpn-route" value="peripheral" id="route-peripheral" />
                        <label for="route-peripheral">Peripheral Line</label>
                    </label>
                </div>
            </div>
        </section>
        
        <!-- Basic Information Section -->
        <section class="section">
            <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h2>
            <div class="input-group">
                <div class="input-field">
                    <label for="bw">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏ß (BW)</label>
                    <div class="input-with-unit">
                        <input type="number" inputmode="decimal" id="bw" step="0.01" 
                               placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏ß"/>
                        <span class="unit">kg</span>
                    </div>
                </div>
                <div class="input-field">
                    <label for="rate">Rate TPN</label>
                    <div class="input-with-unit">
                        <input type="number" inputmode="decimal" id="rate" step="0.1" 
                               placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ"/>
                        <span class="unit">ml/hr</span>
                    </div>
                </div>
            </div>
            <div class="input-group">
                <div class="input-field">
                    <label for="bag">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ Bag TPN (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
                    <div class="input-with-unit">
                        <input type="number" inputmode="numeric" id="bag" step="1" 
                               placeholder="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å Rate"/>
                        <span class="unit">ml</span>
                    </div>
                </div>
                <div class="input-field"><!-- spacer --></div>
            </div>
        </section>
        
        <!-- Macronutrients Section -->
        <section class="section">
            <h2>Macronutrients</h2>
            
            <!-- Macronutrient Inputs -->
            <div class="input-group">
                <div class="input-field">
                    <label for="protein">Protein</label>
                    <div class="input-with-unit">
                        <input type="number" inputmode="decimal" id="protein" step="0.1" 
                               placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô"/>
                        <span class="unit">g/kg/day</span>
                    </div>
                </div>
                <div class="input-field">
                    <label for="fat">Fat</label>
                    <div class="input-with-unit">
                        <input type="number" inputmode="decimal" id="fat" step="0.1" 
                               placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÑ‡∏Ç‡∏°‡∏±‡∏ô"/>
                        <span class="unit">g/kg/day</span>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <div class="input-field">
                    <label for="dextrose">%Dextrose</label>
                    <div class="input-with-unit">
                        <input type="number" inputmode="decimal" id="dextrose" step="0.1" 
                               placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå Dextrose"/>
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="input-field"><!-- spacer --></div>
            </div>
            
            <!-- ‚úÖ GIR Display - Moved here under %Dextrose -->
            <div class="gir-display">
                <div class="gir-label">GIR (Glucose Infusion Rate)</div>
                <div class="calc-result gir-pink" id="gir-result">0 mg/kg/min</div>
            </div>
            
            <!-- Protein Product Selection -->
            <div class="product-selection">
                <h3>üß¨ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Protein Product</h3>
                <div class="product-options">
                    <label class="product-option" data-product="protein">
                        <input type="radio" name="protein-product" value="aminoven" checked>
                        <div class="product-option-label">
                            <div class="product-name">10% Aminoven¬Æ infant</div>
                            <div class="product-info">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏ 0-1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                        </div>
                    </label>
                    <label class="product-option" data-product="protein">
                        <input type="radio" name="protein-product" value="amiparen">
                        <div class="product-option-label">
                            <div class="product-name">10% Amiparen¬Æ</div>
                            <div class="product-info">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                        </div>
                    </label>
                    <label class="product-option" data-product="protein">
                        <input type="radio" name="protein-product" value="aminoplasmal">
                        <div class="product-option-label">
                            <div class="product-name">15% Aminoplasmal¬Æ</div>
                            <div class="product-info">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏™‡∏π‡∏á (‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤)</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Fat Product Selection -->
            <div class="product-selection">
                <h3>üíß ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Fat Product</h3>
                <div class="product-options">
                    <label class="product-option" data-product="fat">
                        <input type="radio" name="fat-product" value="smof" checked>
                        <div class="product-option-label">
                            <div class="product-name">20% SMOF lipid</div>
                            <div class="product-info">Mixed lipid emulsion</div>
                        </div>
                    </label>
                    <label class="product-option" data-product="fat">
                        <input type="radio" name="fat-product" value="intralipid">
                        <div class="product-option-label">
                            <div class="product-name">20% Intralipid</div>
                            <div class="product-info">Soybean oil emulsion</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Summary Table -->
            <div class="tpn-table">
                <div class="table-header">
                    <div class="table-cell header-cell">‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</div>
                    <div class="table-cell header-cell">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (ml)</div>
                    <div class="table-cell header-cell">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà (kcal)</div>
                    <div class="table-cell header-cell">mOsmol/L</div>
                </div>
                <div class="table-row">
                    <div class="table-cell component-cell" id="protein-label">10% Aminoven¬Æ infant</div>
                    <div class="table-cell result-cell volume-yellow" id="protein-volume">0</div>
                    <div class="table-cell result-cell" id="protein-calories">0</div>
                    <div class="table-cell result-cell osmol-purple" id="protein-osmol">0</div>
                </div>
                <div class="table-row">
                    <div class="table-cell component-cell">50% Dextrose</div>
                    <div class="table-cell result-cell volume-yellow" id="dextrose-volume">0</div>
                    <div class="table-cell result-cell" id="dextrose-calories">0</div>
                    <div class="table-cell result-cell osmol-purple" id="dextrose-osmol">0</div>
                </div>
                <div class="table-row">
                    <div class="table-cell component-cell" id="fat-label">20% SMOF lipid</div>
                    <div class="table-cell result-cell volume-yellow" id="fat-volume">0</div>
                    <div class="table-cell result-cell" id="fat-calories">0</div>
                    <div class="table-cell result-cell">-</div>
                </div>
            </div>
        </section>
        
        <!-- Electrolytes Section -->
        <section class="section">
            <h2>Electrolytes</h2>
            
            <!-- Sodium (Na) -->
            <div class="electrolyte-item">
                <div class="electrolyte-header">
                    <div class="electrolyte-input">
                        <label for="na">Na (mEq/kg/day)</label>
                        <input type="text" inputmode="decimal" id="na" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì Na">
                    </div>
                    <div class="electrolyte-result">
                        <div class="electrolyte-result-label">Na ‡∏à‡∏≤‡∏Å Glycophos¬Æ</div>
                        <div class="electrolyte-result-value" id="na-from-glycophos">0 mEq</div>
                    </div>
                </div>
                <div class="source-selection">
                    <h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á Na ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</h4>
                    <label class="source-option">
                        <input type="radio" name="na-source" value="nacl" id="nacl-radio">
                        <span class="source-option-label">3%NaCl (0.5 mEq/ml)</span>
                        <span class="source-option-value" id="nacl-volume">0 ml</span>
                    </label>
                    <label class="source-option">
                        <input type="radio" name="na-source" value="na-acetate" id="na-acetate-radio">
                        <span class="source-option-label">Na acetate (3 mEq/ml)</span>
                        <span class="source-option-value" id="na-acetate-volume">0 ml</span>
                    </label>
                </div>
            </div>
            
            <!-- Phosphorus (P) -->
            <div class="electrolyte-item">
                <div class="electrolyte-header">
                    <div class="electrolyte-input">
                        <label for="p">P (Glycophos¬Æ) (mmol/kg/day)</label>
                        <input type="text" inputmode="decimal" id="p" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì P">
                    </div>
                    <div class="electrolyte-result">
                        <div class="electrolyte-result-label">P Volume</div>
                        <div class="electrolyte-result-value" id="p-volume">0 ml</div>
                    </div>
                </div>
            </div>
            
            <!-- Calcium (Ca) -->
            <div class="electrolyte-item">
                <div class="electrolyte-header">
                    <div class="electrolyte-input">
                        <label for="ca">Ca (mmol/kg/day)</label>
                        <input type="text" inputmode="decimal" id="ca" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì Ca">
                    </div>
                    <div class="electrolyte-result">
                        <div class="electrolyte-result-label">Ca Volume</div>
                        <div class="electrolyte-result-value" id="ca-volume">0 ml</div>
                    </div>
                </div>
            </div>
            
            <!-- Magnesium (Mg) -->
            <div class="electrolyte-item">
                <div class="electrolyte-header">
                    <div class="electrolyte-input">
                        <label for="mg">Mg (mmol/kg/day)</label>
                        <input type="text" inputmode="decimal" id="mg" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì Mg">
                    </div>
                    <div class="electrolyte-result">
                        <div class="electrolyte-result-label">Mg Volume</div>
                        <div class="electrolyte-result-value" id="mg-volume">0 ml</div>
                    </div>
                </div>
            </div>
            
            <!-- Potassium (K) -->
            <div class="electrolyte-item">
                <div class="electrolyte-header">
                    <div class="electrolyte-input">
                        <label for="k">K (mEq/kg/day)</label>
                        <input type="text" inputmode="decimal" id="k" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì K">
                    </div>
                    <div style="display:grid; grid-template-columns:1fr; gap:0;"></div>
                </div>
                <div class="source-selection">
                    <h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á K ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</h4>
                    <label class="source-option">
                        <input type="radio" name="k-source" value="kcl" id="kcl-radio">
                        <span class="source-option-label">15% KCl (2 mEq/ml)</span>
                        <span class="source-option-value" id="kcl-volume">0 ml</span>
                    </label>
                    <label class="source-option">
                        <input type="radio" name="k-source" value="k-acetate" id="k-acetate-radio">
                        <span class="source-option-label">K acetate (3 mEq/ml)</span>
                        <span class="source-option-value" id="k-acetate-volume">0 ml</span>
                    </label>
                </div>
            </div>
        </section>
        
        <!-- Micronutrients Section -->
        <section class="section">
            <h2>Micronutrients</h2>
            <div class="calculation-section" style="background:#f0fdf4; border:2px solid #bbf7d0;">
                
                <!-- Peditrace -->
                <div class="calc-row" style="display:flex; flex-direction:column; align-items:stretch; 
                                              border-bottom:1px solid #f1f5f9; padding-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div class="calc-label bold">Peditrace¬Æ (max 10 ml/day)</div>
                        <div class="calc-result" id="peditrace-volume" 
                             style="background:#dcfce7; color:#166534; border:1px solid #86efac;">
                            0 ml
                        </div>
                    </div>
                    <div class="frequency-selection">
                        <h4>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ:</h4>
                        <label class="frequency-option">
                            <input type="radio" name="peditrace-freq" value="daily" checked>
                            <span class="frequency-option-label">Per day</span>
                        </label>
                        <label class="frequency-option">
                            <input type="radio" name="peditrace-freq" value="mwf">
                            <span class="frequency-option-label">Mon Wed Fri</span>
                        </label>
                        <label class="frequency-option">
                            <input type="radio" name="peditrace-freq" value="weekly">
                            <span class="frequency-option-label">Per week</span>
                        </label>
                        <div class="day-selector" id="peditrace-day-selector">
                            <select id="peditrace-day">
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                                <option value="0">Sunday</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Cernevit -->
                <div class="calc-row" style="display:flex; flex-direction:column; align-items:stretch; 
                                              border-bottom:1px solid #f1f5f9; padding-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div class="calc-label bold">Cernevit¬Æ (max 3 ml/day)</div>
                        <div class="calc-result" id="cernevit-volume" 
                             style="background:#dcfce7; color:#166534; border:1px solid #86efac;">
                            0 ml
                        </div>
                    </div>
                    <div class="frequency-selection">
                        <h4>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ:</h4>
                        <label class="frequency-option">
                            <input type="radio" name="cernevit-freq" value="daily" checked>
                            <span class="frequency-option-label">Per day</span>
                        </label>
                        <label class="frequency-option">
                            <input type="radio" name="cernevit-freq" value="mwf">
                            <span class="frequency-option-label">Mon Wed Fri</span>
                        </label>
                        <label class="frequency-option">
                            <input type="radio" name="cernevit-freq" value="weekly">
                            <span class="frequency-option-label">Per week</span>
                        </label>
                        <div class="day-selector" id="cernevit-day-selector">
                            <select id="cernevit-day">
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                                <option value="0">Sunday</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Vitamin K -->
                <div class="calc-row" style="display:flex; flex-direction:column; align-items:stretch;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div class="calc-label bold">Vitamin K (max 0.5 ml/day)</div>
                    </div>
                    <div class="frequency-selection">
                        <h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ:</h4>
                        <label class="frequency-option" id="vitamin-k-daily-option">
                            <input type="radio" name="vitamin-k-choice" value="daily">
                            <span class="frequency-option-label">Per day</span>
                            <span class="source-option-value" id="vitamin-k-daily" style="margin-left:10px;">
                                0 ml
                            </span>
                        </label>
                        <label class="frequency-option">
                            <input type="radio" name="vitamin-k-choice" value="weekly">
                            <span class="frequency-option-label">Per week</span>
                            <span class="source-option-value" id="vitamin-k-weekly" style="margin-left:10px;">
                                0 ml
                            </span>
                        </label>
                        <div class="day-selector" id="vitamin-k-day-selector">
                            <select id="vitamin-k-day">
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                                <option value="0">Sunday</option>
                            </select>
                        </div>
                        <label class="frequency-option">
                            <input type="radio" name="vitamin-k-choice" value="none" checked>
                            <span class="frequency-option-label" style="color: #dc2626; font-weight: 600;">‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏¥‡∏°</span>
                        </label>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Heparin Section -->
        <section class="section">
            <h2>Add Heparin</h2>
            <div class="calculation-section">
                <div class="calc-row">
                    <div class="calc-label">‡∏°‡∏µ PICC-line ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="checkbox" id="picc-line-checkbox" style="transform:scale(1.2);">
                            <span style="font-weight:500;">‡∏°‡∏µ PICC-line</span>
                        </label>
                    </div>
                    <div></div>
                </div>
                <div class="calc-row">
                    <div class="calc-label">Heparin</div>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span class="calc-result" id="heparin-volume" style="margin-left:5px;">0 ml</span>
                        </div>
                    </div>
                    <div></div>
                </div>
            </div>
        </section>
        
        <!-- Milk Calories Section -->
        <section class="section">
            <h2>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô Calories ‡∏à‡∏≤‡∏Å‡∏ô‡∏° (feed)</h2>
            <div class="input-group">
                <div class="input-field">
                    <label for="milk">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡∏°</label>
                    <div class="input-with-unit">
                        <input type="number" inputmode="numeric" id="milk" step="1" 
                               placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡∏°"/>
                        <span class="unit">ml</span>
                    </div>
                </div>
                <div class="input-field">
                    <label for="total-milk">x 8 feed =</label>
                    <div class="input-with-unit">
                        <input type="number" inputmode="numeric" id="total-milk" step="1" 
                               placeholder="‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡∏°"/>
                        <span class="unit">ml</span>
                    </div>
                </div>
            </div>
            <div class="calculation-section">
                <div class="calc-row">
                    <div class="calc-label">TF ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏ô‡∏°</div>
                    <div class="calc-result" id="tf-from-milk">0 ml/kg/day</div>
                    <div></div>
                </div>
                <div class="calc-row">
                    <div class="calc-label">Calories ‡∏à‡∏≤‡∏Å‡∏ô‡∏°</div>
                    <div class="calc-result" id="milk-calories-kg">0 kcal/kg/day</div>
                    <div></div>
                </div>
            </div>
        </section>
        
        <!-- Sterile Water Section -->
        <section class="total-section" id="sterile-water-section" 
                 style="background:linear-gradient(135deg,#06b6d4 0%,#0891b2 100%);">
            <h2>üíß Sterile Water Volume</h2>
            <div class="total-calories" id="sterile-water-volume">0</div>
            <p>ml</p>
        </section>
        
        <!-- Total Calories Section -->
        <section class="total-section">
            <h2>üéØ Total calories</h2>
            <p style="font-size:.9em; opacity:.9; margin-bottom:15px;">
                (Full calories = 90-120 kcal/kg/day)
            </p>
            <div style="text-align:center; margin-bottom:20px;">
                <h3 style="margin:0 0 10px 0; font-size:1.3em;">Total Calories/day (PN + ‡∏Å‡∏¥‡∏ô)</h3>
                <div class="total-calories" id="total-calories-day">0</div>
                <p>kcal/day</p>
            </div>
            <div style="background:#fef3c7; border-radius:12px; padding:20px; margin-top:15px; border:2px solid #fbbf24;">
                <h4 style="margin:0 0 15px 0; font-size:1.1em; text-align:center; color:#92400e;">
                    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Calories (kcal/kg/day)
                </h4>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; text-align:center;">
                    <div>
                        <p style="margin:0 0 5px 0; font-size:.9em; color:#92400e; font-weight:600;">‡∏à‡∏≤‡∏Å PN</p>
                        <div style="font-size:1.3em; font-weight:700; color:#92400e;" id="breakdown-pn">0</div>
                        <p style="margin:5px 0 0 0; font-size:.8em; color:#92400e;">kcal/kg/day</p>
                    </div>
                    <div>
                        <p style="margin:0 0 5px 0; font-size:.9em; color:#92400e; font-weight:600;">‡∏à‡∏≤‡∏Å‡∏ô‡∏°</p>
                        <div style="font-size:1.3em; font-weight:700; color:#92400e;" id="breakdown-milk">0</div>
                        <p style="margin:5px 0 0 0; font-size:.8em; color:#92400e;">kcal/kg/day</p>
                    </div>
                    <div>
                        <p style="margin:0 0 5px 0; font-size:.9em; color:#92400e; font-weight:600;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        <div style="font-size:1.3em; font-weight:700; color:#92400e;" id="breakdown-total">0</div>
                        <p style="margin:5px 0 0 0; font-size:.8em; color:#92400e;">kcal/kg/day</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Total mOsmol Section -->
        <section class="total-section" id="osmol-section" 
                 style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);">
            <h2>Total mOsmol/L</h2>
            <p style="font-size:.9em; opacity:.9; margin-bottom:15px;">
                (&lt; 900 mOsmol/L ‡∏ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á peripheral)
            </p>
            <div class="total-calories" id="total-osmol">0</div>
            <p>mOsmol/L</p>
        </section>
        
        <!-- Submit Button -->
        <section class="submit-section">
            <button id="submitBtn" class="submit-btn">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á TPN Report</button>
        </section>
    </div>
</main>

<script>
    const defaultConfig = {
        app_title: "TPN Calculator",
        subtitle: "‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å"
    };

    // ===== Auto Calculate Bag Volume =====
    function calculateBagVolume(rate) {
        if (!rate || rate <= 0) return 0;
        const rawVolume = rate * 24 + 20;
        const rounded = Math.ceil(rawVolume / 10) * 10;
        return rounded;
    }

    // ===== Product Selection Visual Feedback =====
    function initProductSelection() {
        // Handle protein product selection
        document.querySelectorAll('.product-option[data-product="protein"]').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.product-option[data-product="protein"]').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                const radio = this.querySelector('input[type="radio"]');
                if (radio) radio.checked = true;
                updateProteinLabel();
                calculateTPN();
            });
        });

        // Handle fat product selection
        document.querySelectorAll('.product-option[data-product="fat"]').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.product-option[data-product="fat"]').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                const radio = this.querySelector('input[type="radio"]');
                if (radio) radio.checked = true;
                updateFatLabel();
                calculateTPN();
            });
        });

        // Set initial selected state
        document.querySelector('.product-option[data-product="protein"] input:checked')?.closest('.product-option').classList.add('selected');
        document.querySelector('.product-option[data-product="fat"] input:checked')?.closest('.product-option').classList.add('selected');
    }

    function updateProteinLabel() {
        const proteinProduct = document.querySelector('input[name="protein-product"]:checked')?.value;
        const label = document.getElementById('protein-label');
        if (!label) return;
        const names = {
            'aminoven': '10% Aminoven¬Æ infant',
            'amiparen': '10% Amiparen¬Æ',
            'aminoplasmal': '15% Aminoplasmal¬Æ'
        };
        label.textContent = names[proteinProduct] || '10% Aminoven¬Æ infant';
    }

    function updateFatLabel() {
        const fatProduct = document.querySelector('input[name="fat-product"]:checked')?.value;
        const label = document.getElementById('fat-label');
        if (!label) return;
        const names = {
            'smof': '20% SMOF lipid',
            'intralipid': '20% Intralipid'
        };
        label.textContent = names[fatProduct] || '20% SMOF lipid';
    }

    // ===== Autosave/Restore =====
    const AUTOSAVE_KEY = 'tpnFormAutosave';

    function autosaveCollect() {
        const ids = ['order-date','patient-hn','patient-name','patient-ward','bw','rate','bag',
                     'protein','dextrose','fat','milk','total-milk','p','na','k','ca','mg'];
        const data = {};
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) data[id] = el.value ?? '';
        });

        const route = document.querySelector('input[name="tpn-route"]:checked')?.value || '';
        const proteinProduct = document.querySelector('input[name="protein-product"]:checked')?.value || 'aminoven';
        const fatProduct = document.querySelector('input[name="fat-product"]:checked')?.value || 'smof';
        const naSrc = document.querySelector('input[name="na-source"]:checked')?.value || '';
        const kSrc = document.querySelector('input[name="k-source"]:checked')?.value || '';
        const peditFreq = document.querySelector('input[name="peditrace-freq"]:checked')?.value || '';
        const cernFreq = document.querySelector('input[name="cernevit-freq"]:checked')?.value || '';
        const vitKChoice = document.querySelector('input[name="vitamin-k-choice"]:checked')?.value || '';
        const peditDay = document.getElementById('peditrace-day')?.value || '1';
        const cernDay = document.getElementById('cernevit-day')?.value || '1';
        const vitKDay = document.getElementById('vitamin-k-day')?.value || '1';
        const hasPicc = document.getElementById('picc-line-checkbox')?.checked || false;

        Object.assign(data, {
            route, proteinProduct, fatProduct, naSrc, kSrc,
            peditFreq, cernFreq, vitKChoice, peditDay, cernDay, vitKDay, hasPicc
        });

        localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
    }

    function autosaveRestore() {
        const raw = localStorage.getItem(AUTOSAVE_KEY);
        if (!raw) return;
        try {
            const data = JSON.parse(raw);
            Object.entries(data).forEach(([k,v]) => {
                if (['order-date','patient-hn','patient-name','patient-ward','bw','rate','bag',
                     'protein','dextrose','fat','milk','total-milk','p','na','k','ca','mg'].includes(k)) {
                    const el = document.getElementById(k);
                    if (el) el.value = v;
                }
            });

            if (data.route) document.querySelector(`input[name="tpn-route"][value="${data.route}"]`)?.click();
            
            if (data.proteinProduct) {
                const proteinRadio = document.querySelector(`input[name="protein-product"][value="${data.proteinProduct}"]`);
                if (proteinRadio) {
                    proteinRadio.checked = true;
                    proteinRadio.closest('.product-option').classList.add('selected');
                }
            }
            
            if (data.fatProduct) {
                const fatRadio = document.querySelector(`input[name="fat-product"][value="${data.fatProduct}"]`);
                if (fatRadio) {
                    fatRadio.checked = true;
                    fatRadio.closest('.product-option').classList.add('selected');
                }
            }

            if (data.naSrc) document.querySelector(`input[name="na-source"][value="${data.naSrc}"]`)?.click();
            if (data.kSrc) document.querySelector(`input[name="k-source"][value="${data.kSrc}"]`)?.click();
            if (data.peditFreq) document.querySelector(`input[name="peditrace-freq"][value="${data.peditFreq}"]`)?.click();
            if (data.cernFreq) document.querySelector(`input[name="cernevit-freq"][value="${data.cernFreq}"]`)?.click();
            if (data.vitKChoice) document.querySelector(`input[name="vitamin-k-choice"][value="${data.vitKChoice}"]`)?.click();

            const pday = document.getElementById('peditrace-day');
            if (pday) pday.value = data.peditDay ?? '1';
            const cday = document.getElementById('cernevit-day');
            if (cday) cday.value = data.cernDay ?? '1';
            const vday = document.getElementById('vitamin-k-day');
            if (vday) vday.value = data.vitKDay ?? '1';
            const picc = document.getElementById('picc-line-checkbox');
            if (picc) picc.checked = !!data.hasPicc;

            updateProteinLabel();
            updateFatLabel();
        } catch(e) { }
    }

    function clearAllData() {
        if (!confirm('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

        const ids = ['patient-hn','patient-name','patient-ward','bw','rate','bag',
                     'protein','dextrose','fat','milk','total-milk','p','na','k','ca','mg'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });

        const dateEl = document.getElementById('order-date');
        if (dateEl) {
            const today = new Date();
            dateEl.value = today.toISOString().split('T')[0];
        }

        document.querySelector('input[name="tpn-route"][value="central"]')?.click();

        // Reset product selections
        const aminovenRadio = document.querySelector('input[name="protein-product"][value="aminoven"]');
        if (aminovenRadio) {
            aminovenRadio.checked = true;
            document.querySelectorAll('.product-option[data-product="protein"]').forEach(opt => opt.classList.remove('selected'));
            aminovenRadio.closest('.product-option').classList.add('selected');
        }

        const smofRadio = document.querySelector('input[name="fat-product"][value="smof"]');
        if (smofRadio) {
            smofRadio.checked = true;
            document.querySelectorAll('.product-option[data-product="fat"]').forEach(opt => opt.classList.remove('selected'));
            smofRadio.closest('.product-option').classList.add('selected');
        }

        document.querySelector('input[name="na-source"]')?.checked && (document.querySelector('input[name="na-source"]').checked = false);
        document.querySelector('input[name="k-source"]')?.checked && (document.querySelector('input[name="k-source"]').checked = false);
        document.querySelector('input[name="peditrace-freq"][value="daily"]')?.click();
        document.querySelector('input[name="cernevit-freq"][value="daily"]')?.click();
        document.querySelector('input[name="vitamin-k-choice"][value="none"]')?.click();

        const peditDay = document.getElementById('peditrace-day');
        if (peditDay) peditDay.value = '1';
        const cernDay = document.getElementById('cernevit-day');
        if (cernDay) cernDay.value = '1';
        const vitKDay = document.getElementById('vitamin-k-day');
        if (vitKDay) vitKDay.value = '1';
        const picc = document.getElementById('picc-line-checkbox');
        if (picc) picc.checked = false;

        if (window.clearStickerImage) {
            window.clearStickerImage();
        }

        localStorage.removeItem(AUTOSAVE_KEY);
        updateProteinLabel();
        updateFatLabel();
        calculateTPN();
        alert('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }

    // ===== Helper Functions =====
    function shouldIncludeMicronutrient(freq, selectedDay, orderDate) {
        if (!orderDate) return false;
        const date = new Date(orderDate);
        const dayOfWeek = date.getDay();
        if (freq === 'daily') return true;
        if (freq === 'mwf') return [1,3,5].includes(dayOfWeek);
        if (freq === 'weekly') return dayOfWeek === parseInt(selectedDay);
        return false;
    }

    function getDayName(dateStr) {
        const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        const d = new Date(dateStr);
        return days[d.getDay()];
    }

    function r1(v) {
        if (!isFinite(v) || v === 0) return 0;
        const h = Math.floor(v * 100);
        const d2 = h % 10;
        return d2 === 9 ? Math.ceil(v * 10) / 10 : Math.floor(v * 10) / 10;
    }

    function r2(v) {
        if (!isFinite(v) || v === 0) return 0;
        const h = Math.floor(v * 1000);
        const d3 = h % 10;
        return d3 === 9 ? Math.ceil(v * 100) / 100 : Math.floor(v * 100) / 100;
    }

    function r0(v) {
        if (!isFinite(v) || v === 0) return 0;
        const m = v * 10;
        const d1 = Math.floor(m) % 10;
        return d1 === 9 ? Math.ceil(v) : Math.floor(v);
    }

    // ===== Main TPN Calculation Function =====
    function calculateTPN() {
        const bw = parseFloat(document.getElementById('bw').value) || 0;
        const rate = parseFloat(document.getElementById('rate').value) || 0;
        const bag = parseFloat(document.getElementById('bag').value) || 0;
        const protein = parseFloat(document.getElementById('protein').value) || 0;
        const dextrose = parseFloat(document.getElementById('dextrose').value) || 0;
        const fat = parseFloat(document.getElementById('fat').value) || 0;
        const milk = parseFloat(document.getElementById('milk').value) || 0;
        const totalMilk = parseFloat(document.getElementById('total-milk').value) || (milk * 8);
        const p = parseFloat(document.getElementById('p').value) || 0;
        const na = parseFloat(document.getElementById('na').value) || 0;
        const k = parseFloat(document.getElementById('k').value) || 0;
        const ca = parseFloat(document.getElementById('ca').value) || 0;
        const mg = parseFloat(document.getElementById('mg').value) || 0;
        const orderDate = document.getElementById('order-date').value;

        // Get selected protein product
        const proteinProduct = document.querySelector('input[name="protein-product"]:checked')?.value || 'aminoven';

        // Calculate protein volume based on product
        let proteinVol_raw;
        if (proteinProduct === 'aminoplasmal') {
            proteinVol_raw = (bw * protein) / 0.15;
        } else {
            proteinVol_raw = (bw * protein * 100) / 10;
        }

        const proteinCal_raw = bw * protein * 4;
        const proteinOsm_raw = bag > 0 ? (protein * bw * 1000 * 10) / bag : 0;

        const dextroseVol_raw = ((dextrose * bag) / 100) * 2;
        const dextroseCal_raw = (dextrose * bag * 3.4) / 100;
        const dextroseOsm_raw = bag > 0 ? (dextrose * 1000 * 5) / 100 : 0;
        const gir_raw = (bw > 0) ? (dextrose * rate) / (6 * bw) : 0;

        const fatVol_1 = r1(fat * bw * 5);
        const fatCal_raw = fat * bw * 10;

        const tfMilk_raw = (bw > 0) ? totalMilk / bw : 0;

        const pVol_1 = r1(p * bw);
        const naFromGly = pVol_1 * 2;
        const naReq_raw = na * bw;
        const rNa_raw = Math.max(0, naReq_raw - naFromGly);
        const naclVol_1 = rNa_raw > 0 ? r1(rNa_raw / 0.5) : 0;
        const naAcVol_1 = rNa_raw > 0 ? r1(rNa_raw / 3.0) : 0;

        const totalK_raw = k * bw;
        const kclVol_1 = totalK_raw > 0 ? r1(totalK_raw / 2.0) : 0;
        const kAcVol_1 = totalK_raw > 0 ? r1(totalK_raw / 3.0) : 0;

        const caVol_1 = r1((ca * bw) / 0.25);
        const mgVol_2 = r2((mg * bw) / 2.0);

        const peditFreq = document.querySelector('input[name="peditrace-freq"]:checked')?.value || 'daily';
        const peditDay = document.getElementById('peditrace-day')?.value || '1';
        const includePeditrace = shouldIncludeMicronutrient(peditFreq, peditDay, orderDate);

        const cernFreq = document.querySelector('input[name="cernevit-freq"]:checked')?.value || 'daily';
        const cernDay = document.getElementById('cernevit-day')?.value || '1';
        const includeCernevit = shouldIncludeMicronutrient(cernFreq, cernDay, orderDate);

        let pedit_raw = 1 * bw;
        let peditExceeded = false;
        if (pedit_raw > 10) {
            pedit_raw = 10;
            peditExceeded = true;
        }
        const pedit_1 = includePeditrace ? r1(pedit_raw) : 0;

        let cern_raw = 1 * bw;
        let cernExceeded = false;
        if (cern_raw > 3) {
            cern_raw = 3;
            cernExceeded = true;
        }
        const cern_1 = includeCernevit ? r1(cern_raw) : 0;

        const vitK_day_raw_calc = (10 * bw / 1000) * 0.5;
        let vitK_day_raw = vitK_day_raw_calc;
        let vitKExceeded = false;
        if (vitK_day_raw > 0.5) {
            vitK_day_raw = 0.5;
            vitKExceeded = true;
        }
        const vitK_week_raw = vitK_day_raw * 7;

        const vkChoice = document.querySelector('input[name="vitamin-k-choice"]:checked')?.value || 'daily';
        const vkDay = document.getElementById('vitamin-k-day')?.value || '1';
        let includeVitaminK = false;
        if (vkChoice === 'daily') includeVitaminK = true;
        else if (vkChoice === 'weekly') includeVitaminK = shouldIncludeMicronutrient('weekly', vkDay, orderDate);

        const picc = document.getElementById('picc-line-checkbox')?.checked || false;
        const hep_calc_1 = r1(bag > 0 ? bag / 50 : 0);
        const hep_disp_1 = picc ? hep_calc_1 : 0;

        let totalUsed = 0;
        totalUsed += proteinVol_raw;
        totalUsed += dextroseVol_raw;
        totalUsed += pVol_1;
        totalUsed += caVol_1;
        totalUsed += mgVol_2;
        totalUsed += pedit_1;
        totalUsed += cern_1;
        totalUsed += hep_disp_1;

        const naSource = document.querySelector('input[name="na-source"]:checked')?.value;
        if (naSource === 'nacl') totalUsed += naclVol_1;
        if (naSource === 'na-acetate') totalUsed += naAcVol_1;

        const kSource = document.querySelector('input[name="k-source"]:checked')?.value;
        if (kSource === 'kcl') totalUsed += kclVol_1;
        if (kSource === 'k-acetate') totalUsed += kAcVol_1;

        if (includeVitaminK) {
            if (vkChoice === 'daily') totalUsed += vitK_day_raw;
            else if (vkChoice === 'weekly') totalUsed += vitK_week_raw;
        }

        const swVol = Math.floor(bag - totalUsed);
        const elyteOsm_raw = bag > 0 ? ((na + k) * bw * 2 * 1000) / bag : 0;
        const totalOsm_raw = proteinOsm_raw + dextroseOsm_raw + elyteOsm_raw;

        // Update DOM (‡∏ï‡πâ‡∏≠‡∏á update ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)
        document.getElementById('protein-volume').textContent = r1(proteinVol_raw).toFixed(1);
        document.getElementById('protein-calories').textContent = r1(proteinCal_raw).toFixed(1);
        document.getElementById('protein-osmol').textContent = r1(proteinOsm_raw).toFixed(1);
        document.getElementById('dextrose-volume').textContent = r1(dextroseVol_raw).toFixed(1);
        document.getElementById('dextrose-calories').textContent = r1(dextroseCal_raw).toFixed(1);
        document.getElementById('dextrose-osmol').textContent = r1(dextroseOsm_raw).toFixed(1);
        document.getElementById('gir-result').textContent = r1(gir_raw).toFixed(1) + ' mg/kg/min';
        document.getElementById('fat-volume').textContent = fatVol_1.toFixed(1);
        document.getElementById('fat-calories').textContent = r1(fatCal_raw).toFixed(1);

        // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Total Calories ‡πÇ‡∏î‡∏¢‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©)
        const displayedProteinCal = parseFloat(document.getElementById('protein-calories').textContent) || 0;
        const displayedDextroseCal = parseFloat(document.getElementById('dextrose-calories').textContent) || 0;
        const displayedFatCal = parseFloat(document.getElementById('fat-calories').textContent) || 0;
        
        const pnCalDay = displayedProteinCal + displayedDextroseCal + displayedFatCal;
        const pnCalKg = bw > 0 ? pnCalDay / bw : 0;
        const milkCalDay = totalMilk * 20 / 30;
        const milkCalKg = bw > 0 ? milkCalDay / bw : 0;
        const totalCalDay = pnCalDay + milkCalDay;
        const dispPN = r0(pnCalKg);
        const dispMilk = r0(milkCalKg);
        const dispTotalKg = dispPN + dispMilk;
        document.getElementById('tf-from-milk').textContent = r0(tfMilk_raw) + ' ml/kg/day';
        document.getElementById('milk-calories-kg').textContent = dispMilk + ' kcal/kg/day';
        document.getElementById('p-volume').textContent = pVol_1.toFixed(1) + ' ml';
        document.getElementById('na-from-glycophos').textContent = r1(naFromGly).toFixed(1) + ' mEq';
        document.getElementById('nacl-volume').textContent = naclVol_1.toFixed(1) + ' ml';
        document.getElementById('na-acetate-volume').textContent = naAcVol_1.toFixed(1) + ' ml';
        document.getElementById('kcl-volume').textContent = kclVol_1.toFixed(1) + ' ml';
        document.getElementById('k-acetate-volume').textContent = kAcVol_1.toFixed(1) + ' ml';
        document.getElementById('ca-volume').textContent = caVol_1.toFixed(1) + ' ml';
        document.getElementById('mg-volume').textContent = mgVol_2.toFixed(2) + ' ml';

        const pedEl = document.getElementById('peditrace-volume');
        if (!includePeditrace) {
            pedEl.textContent = '0 ml (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)';
            pedEl.style.background = '#fef3c7';
            pedEl.style.color = '#92400e';
            pedEl.style.border = '1px solid #fcd34d';
        } else {
            pedEl.textContent = pedit_1.toFixed(1) + ' ml';
            pedEl.style.background = (peditExceeded ? '#dc2626' : '#dcfce7');
            pedEl.style.color = (peditExceeded ? 'white' : '#166534');
            pedEl.style.border = (peditExceeded ? '1px solid #dc2626' : '1px solid #86efac');
        }

        const cerEl = document.getElementById('cernevit-volume');
        if (!includeCernevit) {
            cerEl.textContent = '0 ml (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)';
            cerEl.style.background = '#fef3c7';
            cerEl.style.color = '#92400e';
            cerEl.style.border = '1px solid #fcd34d';
        } else {
            cerEl.textContent = cern_1.toFixed(1) + ' ml';
            cerEl.style.background = (cernExceeded ? '#dc2626' : '#dcfce7');
            cerEl.style.color = (cernExceeded ? 'white' : '#166534');
            cerEl.style.border = (cernExceeded ? '1px solid #dc2626' : '1px solid #86efac');
        }

        const dailyRadio = document.querySelector('input[name="vitamin-k-choice"][value="daily"]');
        const weeklyRadio = document.querySelector('input[name="vitamin-k-choice"][value="weekly"]');
        const dailyOption = document.getElementById('vitamin-k-daily-option');
        const dailyEl = document.getElementById('vitamin-k-daily');
        const weeklyEl = document.getElementById('vitamin-k-weekly');

        if (vitK_day_raw < 0.01) {
            dailyEl.textContent = vitK_day_raw.toFixed(3) + ' ml (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)';
            dailyEl.style.background = '#fef3c7';
            dailyEl.style.color = '#92400e';
            dailyEl.style.border = '1px solid #fcd34d';
            if (dailyRadio) {
                dailyRadio.disabled = true;
                if (dailyOption) {
                    dailyOption.style.opacity = '0.5';
                    dailyOption.style.cursor = 'not-allowed';
                }
            }
            if (dailyRadio && dailyRadio.checked && weeklyRadio) {
                weeklyRadio.checked = true;
            }
        } else {
            dailyEl.textContent = vitK_day_raw.toFixed(3) + ' ml';
            dailyEl.style.background = (vitKExceeded ? '#dc2626' : '#dbeafe');
            dailyEl.style.color = (vitKExceeded ? 'white' : '#1e40af');
            dailyEl.style.border = (vitKExceeded ? '1px solid #dc2626' : '1px solid #bfdbfe');
            if (dailyRadio) {
                dailyRadio.disabled = false;
                if (dailyOption) {
                    dailyOption.style.opacity = '1';
                    dailyOption.style.cursor = 'pointer';
                }
            }
        }

        weeklyEl.textContent = vitK_week_raw.toFixed(3) + ' ml';
        weeklyEl.style.background = '#dbeafe';
        weeklyEl.style.color = '#1e40af';
        weeklyEl.style.border = '1px solid #bfdbfe';

        document.getElementById('heparin-volume').textContent = hep_disp_1.toFixed(1) + ' ml';
        document.getElementById('sterile-water-volume').textContent = swVol;

        const swSec = document.getElementById('sterile-water-section');
        swSec.style.background = swVol < 0 ? 
            'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)' : 
            'linear-gradient(135deg,#06b6d4 0%,#0891b2 100%)';

        document.getElementById('total-osmol').textContent = '~' + r0(totalOsm_raw);

        const osmolSec = document.getElementById('osmol-section');
        osmolSec.style.background = r0(totalOsm_raw) > 900 ? 
            'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)' : 
            'linear-gradient(135deg,#10b981 0%,#059669 100%)';

        document.getElementById('total-calories-day').textContent = r0(totalCalDay);
        document.getElementById('breakdown-pn').textContent = dispPN;
        document.getElementById('breakdown-milk').textContent = dispMilk;
        document.getElementById('breakdown-total').textContent = dispTotalKg;

        autosaveCollect();
    }

    function extractNumberString(text) {
        if (text === undefined || text === null) return '0';
        const s = String(text);
        const m = s.match(/-?\d+(\.\d+)?/);
        return m ? m[0] : '0';
    }

    function getProteinProductName() {
        const value = document.querySelector('input[name="protein-product"]:checked')?.value;
        const names = {
            'aminoven': '10% Aminoven¬Æ infant',
            'amiparen': '10% Amiparen¬Æ',
            'aminoplasmal': '15% Aminoplasmal¬Æ'
        };
        return names[value] || '10% Aminoven¬Æ infant';
    }

    function getFatProductName() {
        const value = document.querySelector('input[name="fat-product"]:checked')?.value;
        const names = {
            'smof': '20% SMOF lipid',
            'intralipid': '20% Intralipid'
        };
        return names[value] || '20% SMOF lipid';
    }

    // ===== DOM Content Loaded Event =====
    document.addEventListener('DOMContentLoaded', function() {
        const dateEl = document.getElementById('order-date');
        if (dateEl && !dateEl.value) {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            dateEl.value = dateStr;
        }

        initProductSelection();
        autosaveRestore();

        const setSelectorDisplay = () => {
            const pf = document.querySelector('input[name="peditrace-freq"]:checked')?.value || 'daily';
            document.getElementById('peditrace-day-selector').style.display = (pf === 'weekly') ? 'block' : 'none';
            const cf = document.querySelector('input[name="cernevit-freq"]:checked')?.value || 'daily';
            document.getElementById('cernevit-day-selector').style.display = (cf === 'weekly') ? 'block' : 'none';
            const vk = document.querySelector('input[name="vitamin-k-choice"]:checked')?.value || 'daily';
            document.getElementById('vitamin-k-day-selector').style.display = (vk === 'weekly') ? 'block' : 'none';
        };
        setSelectorDisplay();

        document.getElementById('clearBtn')?.addEventListener('click', clearAllData);

        // Auto-calculate bag when rate changes
        const rateEl = document.getElementById('rate');
        const bagEl = document.getElementById('bag');
        if (rateEl && bagEl) {
            rateEl.addEventListener('input', function() {
                const rate = parseFloat(this.value) || 0;
                if (rate > 0) {
                    const calculatedBag = calculateBagVolume(rate);
                    bagEl.value = calculatedBag;
                }
                calculateTPN();
            });
        }

        ['bw','bag','protein','dextrose','fat','p','na','k','ca','mg','order-date'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', () => {
                    calculateTPN();
                });
            }
        });

        const milkEl = document.getElementById('milk');
        if (milkEl) {
            milkEl.addEventListener('input', function() {
                const milk = parseFloat(this.value) || 0;
                const t = document.getElementById('total-milk');
                if (t) t.value = (milk * 8).toFixed(0);
                calculateTPN();
            });
        }

        const totMilkEl = document.getElementById('total-milk');
        if (totMilkEl) {
            totMilkEl.addEventListener('input', () => {
                calculateTPN();
            });
        }

        document.querySelectorAll('input[name="na-source"]').forEach(r => r.addEventListener('change', () => {
            calculateTPN();
        }));
        document.querySelectorAll('input[name="k-source"]').forEach(r => r.addEventListener('change', () => {
            calculateTPN();
        }));

        const picc = document.getElementById('picc-line-checkbox');
        if (picc) {
            picc.addEventListener('change', () => {
                calculateTPN();
            });
        }

        document.querySelectorAll('input[name="peditrace-freq"]').forEach(r => {
            r.addEventListener('change', function() {
                document.getElementById('peditrace-day-selector').style.display = this.value === 'weekly' ? 'block' : 'none';
                calculateTPN();
            });
        });

        document.querySelectorAll('input[name="cernevit-freq"]').forEach(r => {
            r.addEventListener('change', function() {
                document.getElementById('cernevit-day-selector').style.display = this.value === 'weekly' ? 'block' : 'none';
                calculateTPN();
            });
        });

        document.querySelectorAll('input[name="vitamin-k-choice"]').forEach(r => {
            r.addEventListener('change', function() {
                document.getElementById('vitamin-k-day-selector').style.display = this.value === 'weekly' ? 'block' : 'none';
                calculateTPN();
            });
        });

        document.getElementById('peditrace-day')?.addEventListener('change', () => {
            calculateTPN();
        });
        document.getElementById('cernevit-day')?.addEventListener('change', () => {
            calculateTPN();
        });
        document.getElementById('vitamin-k-day')?.addEventListener('change', () => {
            calculateTPN();
        });

        calculateTPN();
    });

    // ===== Submit Button Handler =====
    document.getElementById('submitBtn')?.addEventListener('click', function() {
        const bw = document.getElementById('bw')?.value;
        const orderDate = document.getElementById('order-date')?.value;

        if (!bw || !orderDate) {
            alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Body Weight ‡πÅ‡∏•‡∏∞ Order Date');
            return;
        }

        const hasStickerImage = window.hasStickerImage && window.hasStickerImage();
        const hn = document.getElementById('patient-hn')?.value.trim();
        const name = document.getElementById('patient-name')?.value.trim();
        const ward = document.getElementById('patient-ward')?.value.trim();
        const hasManualData = hn && name && ward;

        if (!hasStickerImage && !hasManualData) {
            alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ Patient Sticker ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• HN, ‡∏ä‡∏∑‡πà‡∏≠, Ward ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
            return;
        }

        console.log('‚úÖ Validation passed:', { hasStickerImage, hasManualData });

        const dayName = getDayName(orderDate);
        const dsel = id => document.getElementById(id)?.textContent || document.getElementById(id)?.value || '';

        const reportData = {
            orderDate,
            orderDayName: dayName,
            route: document.querySelector('input[name="tpn-route"]:checked')?.value || 'central',
            proteinProduct: getProteinProductName(),
            fatProduct: getFatProductName(),
            hn: hn || '',
            name: name || '',
            ward: ward || '',
            stickerImage: window.getStickerImage ? window.getStickerImage() : null,
            bw,
            rate: document.getElementById('rate')?.value || '0',
            bag: document.getElementById('bag')?.value || '0',
            protein: document.getElementById('protein')?.value || '0',
            dextrose: document.getElementById('dextrose')?.value || '0',
            fat: document.getElementById('fat')?.value || '0',
            milk: document.getElementById('milk')?.value || '0',
            totalMilk: document.getElementById('total-milk')?.value || '0',
            p: document.getElementById('p')?.value || '0',
            na: document.getElementById('na')?.value || '0',
            k: document.getElementById('k')?.value || '0',
            ca: document.getElementById('ca')?.value || '0',
            mg: document.getElementById('mg')?.value || '0',
            proteinVol: extractNumberString(dsel('protein-volume')),
            proteinCal: extractNumberString(dsel('protein-calories')),
            dextroseVol: extractNumberString(dsel('dextrose-volume')),
            dextroseCal: extractNumberString(dsel('dextrose-calories')),
            fatVol: extractNumberString(dsel('fat-volume')),
            fatCal: extractNumberString(dsel('fat-calories')),
            gir: dsel('gir-result'),
            pVol: extractNumberString(dsel('p-volume')),
            naFromGly: extractNumberString(dsel('na-from-glycophos')),
            naSource: document.querySelector('input[name="na-source"]:checked')?.value || '',
            naclVol: extractNumberString(dsel('nacl-volume')),
            naAcVol: extractNumberString(dsel('na-acetate-volume')),
            kSource: document.querySelector('input[name="k-source"]:checked')?.value || '',
            kclVol: extractNumberString(dsel('kcl-volume')),
            kAcVol: extractNumberString(dsel('k-acetate-volume')),
            caVol: extractNumberString(dsel('ca-volume')),
            mgVol: extractNumberString(dsel('mg-volume')),
            peditrace: extractNumberString(dsel('peditrace-volume')),
            peditFreq: document.querySelector('input[name="peditrace-freq"]:checked')?.value || 'daily',
            peditDay: document.getElementById('peditrace-day')?.value || '1',
            cernevit: extractNumberString(dsel('cernevit-volume')),
            cernFreq: document.querySelector('input[name="cernevit-freq"]:checked')?.value || 'daily',
            cernDay: document.getElementById('cernevit-day')?.value || '1',
            vitKChoice: document.querySelector('input[name="vitamin-k-choice"]:checked')?.value || 'daily',
            vitKDay: document.getElementById('vitamin-k-day')?.value || '1',
            vitKDaily: extractNumberString(dsel('vitamin-k-daily')),
            vitKWeekly: extractNumberString(dsel('vitamin-k-weekly')),
            hasPicc: document.getElementById('picc-line-checkbox')?.checked || false,
            heparinVol: extractNumberString(dsel('heparin-volume')),
            sterileWater: extractNumberString(dsel('sterile-water-volume')),
            totalOsmol: extractNumberString(dsel('total-osmol')),
            totalCalDay: extractNumberString(dsel('total-calories-day')),
            totalCalKg: extractNumberString(dsel('breakdown-total')),
            pnCalKg: extractNumberString(dsel('breakdown-pn')),
            milkCalKg: extractNumberString(dsel('breakdown-milk')),
            tfFromMilk: dsel('tf-from-milk')
        };

        localStorage.setItem('tpnReportData', JSON.stringify(reportData));
        autosaveCollect();
        console.log('‚úÖ Report data saved, redirecting...');
        window.location.href = 'report.html';
    });

    // ‚úÖ Auto Crop Sticker Function
    function autoCropSticker(sourceCanvas) {
        const cropTop = 0.15;
        const cropBottom = 0.25;
        const originalWidth = sourceCanvas.width;
        const originalHeight = sourceCanvas.height;
        const newHeight = originalHeight * (1 - cropTop - cropBottom);
        const startY = originalHeight * cropTop;
        const croppedCanvas = document.createElement('canvas');
        croppedCanvas.width = originalWidth;
        croppedCanvas.height = newHeight;
        const ctx = croppedCanvas.getContext('2d');
        ctx.drawImage(sourceCanvas, 0, startY, originalWidth, newHeight, 0, 0, originalWidth, newHeight);
        return croppedCanvas;
    }

    // ‚úÖ Advanced Image Enhancement Function
    function enhanceImageAdvanced(canvas) {
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const imageData = ctx.getImageData(0, 0, width, height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
            const contrast = 1.3;
            const adjusted = ((gray - 128) * contrast) + 128;
            const clamped = Math.max(0, Math.min(255, adjusted));
            data[i] = data[i + 1] = data[i + 2] = clamped;
        }
        ctx.putImageData(imageData, 0, 0);
        const sharpened = ctx.getImageData(0, 0, width, height);
        const sharpData = sharpened.data;
        const original = imageData.data;
        const kernel = [0, -1, 0, -1, 5, -1, 0, -1, 0];
        for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
                for (let c = 0; c < 3; c++) {
                    let sum = 0;
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                            const kidx = (ky + 1) * 3 + (kx + 1);
                            sum += original[idx] * kernel[kidx];
                        }
                    }
                    const idx = (y * width + x) * 4 + c;
                    sharpData[idx] = Math.max(0, Math.min(255, sum));
                }
            }
        }
        ctx.putImageData(sharpened, 0, 0);
        const finalData = ctx.getImageData(0, 0, width, height);
        const final = finalData.data;
        const threshold = 170;
        for (let i = 0; i < final.length; i += 4) {
            const brightness = final[i];
            if (brightness > threshold) {
                final[i] = final[i + 1] = final[i + 2] = 255;
            } else {
                final[i] = final[i + 1] = final[i + 2] = Math.max(0, brightness - 30);
            }
        }
        ctx.putImageData(finalData, 0, 0);
    }
    // ========== Patient Sticker Camera Feature ==========
    (function initStickerCamera() {
        const openCameraBtn = document.getElementById('openCameraBtn');
        const clearStickerBtn = document.getElementById('clearStickerBtn');
        const cameraModal = document.getElementById('cameraModal');
        const cameraVideo = document.getElementById('cameraVideo');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const captureBtn = document.getElementById('captureBtn');
        const closeCameraBtn = document.getElementById('closeCameraBtn');
        const stickerPreviewContainer = document.getElementById('stickerPreviewContainer');
        const stickerPreview = document.getElementById('stickerPreview');
        const toggleManualInputBtn = document.getElementById('toggleManualInputBtn');
        const manualInputSection = document.getElementById('manualInputSection');
        const toggleIcon = document.getElementById('toggleIcon');

        let currentStream = null;
        let stickerImageData = null;

        // Toggle manual input section
        if (toggleManualInputBtn) {
            toggleManualInputBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const isHidden = manualInputSection.style.display === 'none' || !manualInputSection.style.display;
                manualInputSection.style.display = isHidden ? 'block' : 'none';
                toggleIcon.textContent = isHidden ? '‚ñ≤' : '‚ñº';
                this.style.background = isHidden ? '#e0f2fe' : '#f8fafc';
                this.style.borderColor = isHidden ? '#4facfe' : '#e2e8f0';
                console.log('Toggle clicked, now:', isHidden ? 'OPEN' : 'CLOSED');
            });
        }

        // Open camera
        if (openCameraBtn) {
            openCameraBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920, min: 1280 },
                            height: { ideal: 1080, min: 720 }
                        }
                    });
                    cameraVideo.srcObject = currentStream;
                    cameraModal.style.display = 'flex';
                } catch(err) {
                    alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + err.message);
                }
            });
        }

// Capture photo
if (captureBtn) {
    captureBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const processingMsg = document.createElement('div');
        processingMsg.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); color:white; padding:20px 30px; border-radius:12px; z-index:10000; font-size:16px; font-weight:600;';
        processingMsg.textContent = '‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏†‡∏≤‡∏û...';
        document.body.appendChild(processingMsg);
        
        setTimeout(() => {
            const context = cameraCanvas.getContext('2d');
            cameraCanvas.width = cameraVideo.videoWidth;
            cameraCanvas.height = cameraVideo.videoHeight;
            context.drawImage(cameraVideo, 0, 0);
            
            // ‚úÖ Step 1: Auto Crop
            const croppedCanvas = autoCropSticker(cameraCanvas);
            
            // ‚úÖ Step 2: Enhance
            enhanceImageAdvanced(croppedCanvas);
            
            // ‚úÖ Save
            const imageDataUrl = croppedCanvas.toDataURL('image/jpeg', 0.95);
            stickerImageData = imageDataUrl;
            showStickerPreview(imageDataUrl);
            closeCamera();
            
            document.body.removeChild(processingMsg);
        }, 100);
    });
}
        // Close camera
        if (closeCameraBtn) {
            closeCameraBtn.addEventListener('click', function(e) {
                e.preventDefault();
                closeCamera();
            });
        }

        function closeCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            cameraModal.style.display = 'none';
        }

        // Show sticker preview
        function showStickerPreview(dataUrl) {
            stickerPreview.src = dataUrl;
            stickerPreviewContainer.style.display = 'block';
            clearStickerBtn.style.display = 'inline-flex';
            const currentData = JSON.parse(localStorage.getItem(AUTOSAVE_KEY) || '{}');
            currentData.stickerImage = dataUrl;
            localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(currentData));
        }

        // Clear sticker
        if (clearStickerBtn) {
            clearStickerBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏π‡∏õ Sticker ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
                clearStickerImage();
            });
        }

        function clearStickerImage() {
            stickerImageData = null;
            stickerPreview.src = '';
            stickerPreviewContainer.style.display = 'none';
            clearStickerBtn.style.display = 'none';
            const currentData = JSON.parse(localStorage.getItem(AUTOSAVE_KEY) || '{}');
            delete currentData.stickerImage;
            localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(currentData));
        }

        // Restore from autosave
        try {
            const savedData = JSON.parse(localStorage.getItem(AUTOSAVE_KEY) || '{}');
            if (savedData.stickerImage) {
                stickerImageData = savedData.stickerImage;
                showStickerPreview(stickerImageData);
            }
        } catch(e) {}

        // Export functions
        window.hasStickerImage = function() {
            return !!stickerImageData;
        };
        window.getStickerImage = function() {
            return stickerImageData;
        };
        window.clearStickerImage = clearStickerImage;
    })();
</script>
</body>
</html>
