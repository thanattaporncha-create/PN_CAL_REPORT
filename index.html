<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TPN Calculator</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body { box-sizing: border-box; font-family: 'Sarabun','Noto Sans Thai',Arial,sans-serif; margin:0; padding:20px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100%; }
    .container { max-width:800px; margin:0 auto; background:white; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,0.1); overflow:hidden; position:relative; }
    .clear-btn { position:absolute; top:20px; right:20px; background:#ef4444; color:white; border:none; padding:10px 20px; font-size:0.9em; border-radius:8px; cursor:pointer; box-shadow:0 2px 8px rgba(239,68,68,0.3); transition:all 0.3s; font-weight:600; z-index:10; }
    .clear-btn:hover { background:#dc2626; transform:translateY(-2px); box-shadow:0 4px 12px rgba(239,68,68,0.5); }
    .clear-btn:active { transform:translateY(0); }
    .header { background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%); color:white; padding:30px; padding-top:60px; text-align:center; }
    .header h1 { margin:0 0 10px 0; font-size:2.2em; font-weight:600; }
    .header p { margin:0; font-size:1.1em; opacity:.9; }
    .content { padding:30px; }
    .section { background:#f8fafc; border-radius:12px; padding:25px; margin-bottom:25px; border-left:4px solid #4facfe; }
    .section h2 { color:#2d3748; margin:0 0 20px 0; font-size:1.4em; font-weight:600; }
    .input-group { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
    .input-field { display:flex; flex-direction:column; }
    .input-field label { color:#4a5568; font-weight:500; margin-bottom:8px; font-size:.95em; }
    .input-with-unit { display:flex; align-items:center; position:relative; }
    .input-field input { padding:12px 16px; border:2px solid #e2e8f0; border-radius:8px; font-size:1em; transition:all .3s ease; background:white; flex:1; padding-right:60px; -webkit-appearance:none; -moz-appearance:textfield; }
    .input-field input[type="date"] { padding:12px 16px; padding-right:16px; }
    .input-field input::-webkit-outer-spin-button,.input-field input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
    .input-field input:focus { outline:none; border-color:#4facfe; box-shadow:0 0 0 3px rgba(79,172,254,.1); }
    .unit { position:absolute; right:16px; color:#718096; font-size:.9em; font-weight:500; pointer-events:none; background:white; padding-left:8px; }

    .tpn-table { background:white; border-radius:12px; overflow:hidden; margin-top:20px; border:2px solid #e2e8f0; width:100%; display:table; table-layout:fixed; }
    .table-header { display:table-row; background:#f8fafc; border-bottom:2px solid #e2e8f0; }
    .table-row { display:table-row; border-bottom:1px solid #f1f5f9; }
    .table-row:last-child { border-bottom:none; }
    .table-cell { display:table-cell; padding:10px 8px; text-align:center; vertical-align:middle; min-height:50px; box-sizing:border-box; border-right:1px solid #f1f5f9; }
    .table-cell:last-child { border-right:none; }
    .header-cell { font-weight:600; color:#2d3748; background:#f8fafc; font-size:.9em; width:25%; }
    .component-cell { font-weight:500; color:#2d3748; text-align:left; padding-left:16px; font-size:.95em; width:25%; }
    .result-cell { font-weight:600; color:#0369a1; background:#f0f9ff; font-size:.85em; text-align:center; width:25%; }
    .result-cell.volume-yellow { background:#fef3c7; color:#92400e; border:1px solid #fcd34d; }
    .result-cell.osmol-purple { background:#f3e8ff; color:#7c3aed; border:1px solid #c4b5fd; }

    .gir-display { display:flex; justify-content:space-between; align-items:center; background:white; border-radius:8px; padding:15px; margin-top:15px; border:2px solid #e2e8f0; }
    .gir-label { font-weight:500; color:#2d3748; }
    .calc-result { background:#f0f9ff; padding:8px 12px; border-radius:6px; text-align:center; font-weight:600; color:#0369a1; border:1px solid #bae6fd; }
    .calc-result.gir-pink { background:#fce7f3; color:#be185d; border:1px solid #f9a8d4; }

    .calculation-section { background:white; border-radius:12px; padding:20px; margin-top:15px; border:2px solid #e2e8f0; }
    .calc-row { display:grid; grid-template-columns:2fr 1fr 1fr; gap:15px; align-items:center; padding:12px 0; border-bottom:1px solid #f1f5f9; }
    .calc-row:last-child { border-bottom:none; }
    .calc-label { font-weight:500; color:#2d3748; }
    .calc-label.bold { font-weight:700; color:#1e293b; }

    .total-section { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border-radius:12px; padding:25px; text-align:center; margin-top:25px; }
    .total-section h2 { margin:0 0 15px 0; font-size:1.6em; }
    .total-calories { font-size:2.5em; font-weight:700; margin:10px 0; }

    /* Route selection */
    .route-selection { margin-top:20px; }
    .route-selection h3 { color:#2d3748; margin:0 0 15px 0; font-size:1.1em; font-weight:600; }
    .route-options { display:flex; gap:15px; }
    .route-option { flex:1; display:flex; align-items:center; justify-content:center; padding:15px; border-radius:8px; border:2px solid #e2e8f0; background:#f8fafc; cursor:pointer; transition:all .3s ease; }
    .route-option:hover { background:#f0f9ff; border-color:#4facfe; }
    .route-option input[type="radio"] { margin-right:10px; transform:scale(1.3); cursor:pointer; }
    .route-option label { font-weight:500; color:#2d3748; cursor:pointer; font-size:1em; }
    .route-option input[type="radio"]:checked + label { color:#4facfe; font-weight:600; }

    /* Electrolyte styles */
    .electrolyte-item { background:white; border-radius:8px; padding:20px; margin-bottom:15px; border:2px solid #e2e8f0; }
    .electrolyte-header { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px; }
    .electrolyte-input { display:flex; flex-direction:column; }
    .electrolyte-input label { color:#4a5568; font-weight:600; margin-bottom:8px; font-size:1em; }
    .electrolyte-input input { padding:12px 16px; border:2px solid #e2e8f0; border-radius:8px; font-size:1em; transition:all .3s ease; background:white; -webkit-appearance:none; -moz-appearance:textfield; }
    .electrolyte-input input::-webkit-outer-spin-button,.electrolyte-input input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
    .electrolyte-input input:focus { outline:none; border-color:#4facfe; box-shadow:0 0 0 3px rgba(79,172,254,.1); }
    .electrolyte-result { background:#f0fdf4; border:2px solid #86efac; border-radius:8px; padding:12px; text-align:center; }
    .electrolyte-result-label { font-size:0.85em; color:#166534; font-weight:500; margin-bottom:4px; }
    .electrolyte-result-value { font-size:1.3em; color:#166534; font-weight:700; }

    .source-selection { margin-top:15px; padding-top:15px; border-top:1px solid #e2e8f0; }
    .source-selection h4 { margin:0 0 12px 0; color:#2d3748; font-size:0.95em; font-weight:600; }
    .source-option { display:flex; align-items:center; padding:10px; margin-bottom:8px; border-radius:6px; background:#f8fafc; transition:all .2s ease; cursor:pointer; }
    .source-option:hover { background:#f0f9ff; }
    .source-option input[type="radio"] { margin-right:12px; transform:scale(1.3); cursor:pointer; }
    .source-option-label { flex:1; font-weight:500; color:#2d3748; }
    .source-option-value { background:#dbeafe; color:#1e40af; padding:6px 12px; border-radius:4px; font-weight:600; font-size:0.9em; min-width:60px; text-align:center; }

    /* Frequency selection */
    .frequency-selection { margin-top:15px; padding-top:15px; border-top:1px solid #e2e8f0; }
    .frequency-selection h4 { margin:0 0 12px 0; color:#2d3748; font-size:0.95em; font-weight:600; }
    .frequency-option { display:flex; align-items:center; padding:10px; margin-bottom:8px; border-radius:6px; background:#f8fafc; transition:all .2s ease; cursor:pointer; }
    .frequency-option:hover { background:#f0f9ff; }
    .frequency-option input[type="radio"] { margin-right:12px; transform:scale(1.3); cursor:pointer; }
    .frequency-option-label { flex:1; font-weight:500; color:#2d3748; }
    .day-selector { margin-left:30px; margin-top:8px; display:none; }
    .day-selector select { padding:8px 12px; border:2px solid #e2e8f0; border-radius:6px; font-size:0.95em; }

    /* Submit */
    .submit-section { text-align:center; margin-top:30px; }
    .submit-btn { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; padding:18px 50px; font-size:1.2em; border-radius:50px; cursor:pointer; box-shadow:0 4px 15px rgba(102,126,234,0.4); transition:all 0.3s; font-weight:600; }
    .submit-btn:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(102,126,234,0.6); }
    .submit-btn:active { transform:translateY(0); }

    @media (max-width:768px){
      .clear-btn { top:10px; right:10px; padding:8px 16px; font-size:0.85em; }
      .header { padding-top:50px; }
      .input-group{grid-template-columns:1fr}
      .route-options{flex-direction:column}
      .electrolyte-header{grid-template-columns:1fr}
      .tpn-table{font-size:.85em;border-radius:8px}
      .table-cell{padding:8px 4px;min-height:45px}
      .component-cell{padding-left:8px;font-size:.85em}
      .result-cell{font-size:.8em}
      .header-cell{font-size:.8em;padding:8px 4px}
      .gir-display{flex-direction:column;gap:10px;text-align:center}
      .container{margin:10px;border-radius:12px}
      .content{padding:20px}
      .total-section{padding:20px}
      .total-section h2{font-size:1.3em}
      .total-calories{font-size:2em}
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>
<body>
<main class="container">
  <!-- Clear Data Button -->
  <button id="clearBtn" class="clear-btn">üóëÔ∏è Clear data</button>

  <header class="header">
    <h1 id="app-title">TPN Calculator</h1>
    <p id="subtitle">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å</p>
  </header>

  <div class="content">

    <!-- Order Date -->
    <section class="section">
      <h2>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Order TPN</h2>
      <div class="input-group">
        <div class="input-field">
          <label for="order-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <div class="input-with-unit">
            <input type="date" id="order-date" style="padding-right:16px;">
          </div>
        </div>
        <div class="input-field"><!-- spacer --></div>
      </div>
    </section>

    <!-- Patient Info -->
    <section class="section">
      <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
      <div class="input-group">
        <div class="input-field">
          <label for="patient-hn">HN</label>
          <div class="input-with-unit">
            <input type="text" id="patient-hn" placeholder="‡∏Å‡∏£‡∏≠‡∏Å HN" style="padding-right:16px;">
          </div>
        </div>
        <div class="input-field">
          <label for="patient-name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <div class="input-with-unit">
            <input type="text" id="patient-name" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" style="padding-right:16px;">
          </div>
        </div>
      </div>
      <div class="input-group">
        <div class="input-field">
          <label for="patient-ward">Ward</label>
          <div class="input-with-unit">
            <input type="text" id="patient-ward" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Ward" style="padding-right:16px;">
          </div>
        </div>
        <div class="input-field"><!-- spacer --></div>
      </div>

      <!-- Route -->
      <div class="route-selection">
        <h3>Route ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ TPN</h3>
        <div class="route-options">
          <label class="route-option">
            <input type="radio" name="tpn-route" value="central" id="route-central" checked />
            <label for="route-central">Central Line</label>
          </label>
          <label class="route-option">
            <input type="radio" name="tpn-route" value="peripheral" id="route-peripheral" />
            <label for="route-peripheral">Peripheral Line</label>
          </label>
        </div>
      </div>
    </section>

    <!-- Basic -->
    <section class="section">
      <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h2>
      <div class="input-group">
        <div class="input-field">
          <label for="bw">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏ß (BW)</label>
          <div class="input-with-unit">
            <input type="number" inputmode="decimal" id="bw" step="0.01" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏ß"/>
            <span class="unit">kg</span>
          </div>
        </div>
        <div class="input-field">
          <label for="rate">Rate TPN</label>
          <div class="input-with-unit">
            <input type="number" inputmode="decimal" id="rate" step="0.1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ"/>
            <span class="unit">ml/hr</span>
          </div>
        </div>
      </div>
      <div class="input-group">
        <div class="input-field">
          <label for="bag">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ Bag TPN</label>
          <div class="input-with-unit">
            <input type="number" inputmode="numeric" id="bag" step="1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ñ‡∏∏‡∏á TPN"/>
            <span class="unit">ml</span>
          </div>
        </div>
        <div class="input-field"><!-- spacer --></div>
      </div>
    </section>

    <!-- Macronutrients -->
    <section class="section">
      <h2>Macronutrients</h2>
      <div class="input-group">
        <div class="input-field">
          <label for="protein">Protein</label>
          <div class="input-with-unit">
            <input type="number" inputmode="decimal" id="protein" step="0.1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô"/>
            <span class="unit">g/kg/day</span>
          </div>
        </div>
        <div class="input-field">
          <label for="dextrose">%Dextrose</label>
          <div class="input-with-unit">
            <input type="number" inputmode="decimal" id="dextrose" step="0.1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå Dextrose"/>
            <span class="unit">%</span>
          </div>
        </div>
      </div>
      <div class="input-group">
        <div class="input-field">
          <label for="fat">Fat</label>
          <div class="input-with-unit">
            <input type="number" inputmode="decimal" id="fat" step="0.1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÑ‡∏Ç‡∏°‡∏±‡∏ô"/>
            <span class="unit">g/kg/day</span>
          </div>
        </div>
      </div>

      <div class="tpn-table">
        <div class="table-header">
          <div class="table-cell header-cell">‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</div>
          <div class="table-cell header-cell">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (ml)</div>
          <div class="table-cell header-cell">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà (kcal)</div>
          <div class="table-cell header-cell">mOsmol/L</div>
        </div>
        <div class="table-row">
          <div class="table-cell component-cell">10% Protein</div>
          <div class="table-cell result-cell volume-yellow" id="protein-volume">0</div>
          <div class="table-cell result-cell" id="protein-calories">0</div>
          <div class="table-cell result-cell osmol-purple" id="protein-osmol">0</div>
        </div>
        <div class="table-row">
          <div class="table-cell component-cell">50% Dextrose</div>
          <div class="table-cell result-cell volume-yellow" id="dextrose-volume">0</div>
          <div class="table-cell result-cell" id="dextrose-calories">0</div>
          <div class="table-cell result-cell osmol-purple" id="dextrose-osmol">0</div>
        </div>
        <div class="table-row">
          <div class="table-cell component-cell">20% Fat</div>
          <div class="table-cell result-cell volume-yellow" id="fat-volume">0</div>
          <div class="table-cell result-cell" id="fat-calories">0</div>
          <div class="table-cell result-cell">-</div>
        </div>
      </div>

      <div class="gir-display">
        <div class="gir-label">GIR (Glucose Infusion Rate)</div>
        <div class="calc-result gir-pink" id="gir-result">0 mg/kg/min</div>
      </div>
    </section>

    <!-- Electrolytes -->
    <section class="section">
      <h2>Electrolytes</h2>

      <!-- Na -->
      <div class="electrolyte-item">
        <div class="electrolyte-header">
          <div class="electrolyte-input">
            <label for="na">Na (mEq/kg/day)</label>
            <input type="text" inputmode="decimal" id="na" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì Na">
          </div>
          <div class="electrolyte-result">
            <div class="electrolyte-result-label">Na ‡∏à‡∏≤‡∏Å Glycophos¬Æ</div>
            <div class="electrolyte-result-value" id="na-from-glycophos">0 mEq</div>
          </div>
        </div>

        <div class="source-selection">
          <h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á Na ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</h4>
          <label class="source-option">
            <input type="radio" name="na-source" value="nacl" id="nacl-radio">
            <span class="source-option-label">3%NaCl (0.5 mEq/ml)</span>
            <span class="source-option-value" id="nacl-volume">0 ml</span>
          </label>
          <label class="source-option">
            <input type="radio" name="na-source" value="na-acetate" id="na-acetate-radio">
            <span class="source-option-label">Na acetate (3 mEq/ml)</span>
            <span class="source-option-value" id="na-acetate-volume">0 ml</span>
          </label>
        </div>
      </div>

      <!-- P -->
      <div class="electrolyte-item">
        <div class="electrolyte-header">
          <div class="electrolyte-input">
            <label for="p">P (Glycophos¬Æ) (mmol/kg/day)</label>
            <input type="text" inputmode="decimal" id="p" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì P">
          </div>
          <div class="electrolyte-result">
            <div class="electrolyte-result-label">P Volume</div>
            <div class="electrolyte-result-value" id="p-volume">0 ml</div>
          </div>
        </div>
      </div>

      <!-- Ca -->
      <div class="electrolyte-item">
        <div class="electrolyte-header">
          <div class="electrolyte-input">
            <label for="ca">Ca (mmol/kg/day)</label>
            <input type="text" inputmode="decimal" id="ca" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì Ca">
          </div>
          <div class="electrolyte-result">
            <div class="electrolyte-result-label">Ca Volume</div>
            <div class="electrolyte-result-value" id="ca-volume">0 ml</div>
          </div>
        </div>
      </div>

      <!-- Mg -->
      <div class="electrolyte-item">
        <div class="electrolyte-header">
          <div class="electrolyte-input">
            <label for="mg">Mg (mmol/kg/day)</label>
            <input type="text" inputmode="decimal" id="mg" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì Mg">
          </div>
          <div class="electrolyte-result">
            <div class="electrolyte-result-label">Mg Volume</div>
            <div class="electrolyte-result-value" id="mg-volume">0 ml</div>
          </div>
        </div>
      </div>

      <!-- K -->
      <div class="electrolyte-item">
        <div class="electrolyte-header">
          <div class="electrolyte-input">
            <label for="k">K (mEq/kg/day)</label>
            <input type="text" inputmode="decimal" id="k" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì K">
          </div>
          <div style="display:grid; grid-template-columns:1fr; gap:0;"></div>
        </div>

        <div class="source-selection">
          <h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á K ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</h4>
          <label class="source-option">
            <input type="radio" name="k-source" value="kcl" id="kcl-radio">
            <span class="source-option-label">15% KCl (2 mEq/ml)</span>
            <span class="source-option-value" id="kcl-volume">0 ml</span>
          </label>
          <label class="source-option">
            <input type="radio" name="k-source" value="k-acetate" id="k-acetate-radio">
            <span class="source-option-label">K acetate (3 mEq/ml)</span>
            <span class="source-option-value" id="k-acetate-volume">0 ml</span>
          </label>
        </div>
      </div>

    </section>

    <!-- Micronutrients -->
    <section class="section">
      <h2>Micronutrients</h2>
      <div class="calculation-section" style="background:#f0fdf4; border:2px solid #bbf7d0;">

        <!-- Peditrace -->
        <div class="calc-row" style="display:flex; flex-direction:column; align-items:stretch; border-bottom:1px solid #f1f5f9; padding-bottom:15px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div class="calc-label bold">Peditrace¬Æ (max 10 ml/day)</div>
            <div class="calc-result" id="peditrace-volume" style="background:#dcfce7; color:#166534; border:1px solid #86efac;">0 ml</div>
          </div>
          <div class="frequency-selection">
            <h4>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ:</h4>
            <label class="frequency-option">
              <input type="radio" name="peditrace-freq" value="daily" checked>
              <span class="frequency-option-label">Per day</span>
            </label>
            <label class="frequency-option">
              <input type="radio" name="peditrace-freq" value="mwf">
              <span class="frequency-option-label">Mon Wed Fri</span>
            </label>
            <label class="frequency-option">
              <input type="radio" name="peditrace-freq" value="weekly">
              <span class="frequency-option-label">Per week</span>
            </label>
            <div class="day-selector" id="peditrace-day-selector">
              <select id="peditrace-day">
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
                <option value="0">Sunday</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Cernevit -->
        <div class="calc-row" style="display:flex; flex-direction:column; align-items:stretch; border-bottom:1px solid #f1f5f9; padding-bottom:15px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div class="calc-label bold">Cernevit¬Æ (max 3 ml/day)</div>
            <div class="calc-result" id="cernevit-volume" style="background:#dcfce7; color:#166534; border:1px solid #86efac;">0 ml</div>
          </div>
          <div class="frequency-selection">
            <h4>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ:</h4>
            <label class="frequency-option">
              <input type="radio" name="cernevit-freq" value="daily" checked>
              <span class="frequency-option-label">Per day</span>
            </label>
            <label class="frequency-option">
              <input type="radio" name="cernevit-freq" value="mwf">
              <span class="frequency-option-label">Mon Wed Fri</span>
            </label>
            <label class="frequency-option">
              <input type="radio" name="cernevit-freq" value="weekly">
              <span class="frequency-option-label">Per week</span>
            </label>
            <div class="day-selector" id="cernevit-day-selector">
              <select id="cernevit-day">
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
                <option value="0">Sunday</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Vitamin K -->
        <div class="calc-row" style="display:flex; flex-direction:column; align-items:stretch;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div class="calc-label bold">Vitamin K (max 0.5 ml/day)</div>
          </div>
          <div class="frequency-selection">
            <h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ:</h4>
            <label class="frequency-option">
              <input type="radio" name="vitamin-k-choice" value="none" checked>
              <span class="frequency-option-label">‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏¥‡∏°</span>
            </label>
            <label class="frequency-option">
              <input type="radio" name="vitamin-k-choice" value="daily">
              <span class="frequency-option-label">Per day</span>
              <span class="source-option-value" id="vitamin-k-daily" style="margin-left:10px;">0 ml</span>
            </label>
            <label class="frequency-option">
              <input type="radio" name="vitamin-k-choice" value="weekly">
              <span class="frequency-option-label">Per week</span>
              <span class="source-option-value" id="vitamin-k-weekly" style="margin-left:10px;">0 ml</span>
            </label>
            <div class="day-selector" id="vitamin-k-day-selector">
              <select id="vitamin-k-day">
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
                <option value="0">Sunday</option>
              </select>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Heparin -->
    <section class="section">
      <h2>Add Heparin</h2>
      <div class="calculation-section">
        <div class="calc-row">
          <div class="calc-label">‡∏°‡∏µ PICC-line ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</div>
          <div style="display:flex; align-items:center; gap:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" id="picc-line-checkbox" style="transform:scale(1.2);">
              <span style="font-weight:500;">‡∏°‡∏µ PICC-line</span>
            </label>
          </div>
          <div></div>
        </div>
        <div class="calc-row">
          <div class="calc-label">Heparin</div>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <div style="display:flex; align-items:center; gap:10px;">
              <span class="calc-result" id="heparin-volume" style="margin-left:5px;">0 ml</span>
            </div>
          </div>
          <div></div>
        </div>
      </div>
    </section>

    <!-- Milk -->
    <section class="section">
      <h2>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô Calories ‡∏à‡∏≤‡∏Å‡∏ô‡∏° (feed)</h2>
      <div class="input-group">
        <div class="input-field">
          <label for="milk">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡∏°</label>
          <div class="input-with-unit">
            <input type="number" inputmode="numeric" id="milk" step="1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡∏°"/>
            <span class="unit">ml</span>
          </div>
        </div>
        <div class="input-field">
          <label for="total-milk">x 8 feed =</label>
          <div class="input-with-unit">
            <input type="number" inputmode="numeric" id="total-milk" step="1" placeholder="‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡∏°"/>
            <span class="unit">ml</span>
          </div>
        </div>
      </div>
      <div class="calculation-section">
        <div class="calc-row">
          <div class="calc-label">TF ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏ô‡∏°</div>
          <div class="calc-result" id="tf-from-milk">0 ml/kg/day</div>
          <div></div>
        </div>
        <div class="calc-row">
          <div class="calc-label">Calories ‡∏à‡∏≤‡∏Å‡∏ô‡∏°</div>
          <div class="calc-result" id="milk-calories-kg">0 kcal/kg/day</div>
          <div></div>
        </div>
      </div>
    </section>

    <!-- Sterile Water -->
    <section class="total-section" id="sterile-water-section" style="background:linear-gradient(135deg,#06b6d4 0%,#0891b2 100%);">
      <h2>üíß Sterile Water Volume</h2>
      <div class="total-calories" id="sterile-water-volume">0</div>
      <p>ml</p>
    </section>

    <!-- Total calories -->
    <section class="total-section">
      <h2>üéØ Total calories</h2>
      <p style="font-size:.9em; opacity:.9; margin-bottom:15px;">(Full calories = 90-120 kcal/kg/day)</p>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
        <div style="text-align:center;">
          <h3 style="margin:0 0 10px 0; font-size:1.2em;">Total Calories/day</h3>
          <div class="total-calories" id="total-calories-day">0</div>
          <p>kcal/day</p>
        </div>
        <div style="text-align:center;">
          <h3 style="margin:0 0 10px 0; font-size:1.2em;">Total Calories/kg/day</h3>
          <div class="total-calories" id="total-calories-kg">0</div>
          <p>kcal/kg/day</p>
        </div>
      </div>
      <div style="background:rgba(255,255,255,0.2); border-radius:12px; padding:20px; margin-top:15px;">
        <h4 style="margin:0 0 15px 0; font-size:1.1em; text-align:center;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Calories</h4>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; text-align:center;">
          <div><p style="margin:0 0 5px 0; font-size:.9em; opacity:.8;">‡∏à‡∏≤‡∏Å PN</p><div style="font-size:1.3em; font-weight:600;" id="breakdown-pn">0</div><p style="margin:5px 0 0 0; font-size:.8em;">kcal/kg/day</p></div>
          <div><p style="margin:0 0 5px 0; font-size:.9em; opacity:.8;">‡∏à‡∏≤‡∏Å‡∏ô‡∏°</p><div style="font-size:1.3em; font-weight:600;" id="breakdown-milk">0</div><p style="margin:5px 0 0 0; font-size:.8em;">kcal/kg/day</p></div>
          <div><p style="margin:0 0 5px 0; font-size:.9em; opacity:.8;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><div style="font-size:1.3em; font-weight:600;" id="breakdown-total">0</div><p style="margin:5px 0 0 0; font-size:.8em;">kcal/kg/day</p></div>
        </div>
      </div>
    </section>

    <!-- Total mOsmol -->
    <section class="total-section" id="osmol-section" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);">
      <h2>Total mOsmol/L</h2>
      <p style="font-size:.9em; opacity:.9; margin-bottom:15px;">(&lt; 900 mOsmol/L ‡∏ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á peripheral)</p>
      <div class="total-calories" id="total-osmol">0</div>
      <p>mOsmol/L</p>
    </section>

    <!-- Submit -->
    <section class="submit-section">
      <button id="submitBtn" class="submit-btn">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF</button>
    </section>

  </div>
</main>

<script>
  const defaultConfig = { app_title:"TPN Calculator", subtitle:"‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å" };

  // ===== Autosave/Restore =====
  const AUTOSAVE_KEY = 'tpnFormAutosave';

  function autosaveCollect() {
    const ids = ['order-date','patient-hn','patient-name','patient-ward','bw','rate','bag','protein','dextrose','fat','milk','total-milk','p','na','k','ca','mg'];
    const data = {};
    ids.forEach(id => { const el = document.getElementById(id); if (el) data[id] = el.value ?? ''; });
    const route = document.querySelector('input[name="tpn-route"]:checked')?.value || '';
    const naSrc = document.querySelector('input[name="na-source"]:checked')?.value || '';
    const kSrc  = document.querySelector('input[name="k-source"]:checked')?.value || '';
    const peditFreq = document.querySelector('input[name="peditrace-freq"]:checked')?.value || '';
    const cernFreq  = document.querySelector('input[name="cernevit-freq"]:checked')?.value || '';
    const vitKChoice= document.querySelector('input[name="vitamin-k-choice"]:checked')?.value || '';
    const peditDay  = document.getElementById('peditrace-day')?.value || '1';
    const cernDay   = document.getElementById('cernevit-day')?.value || '1';
    const vitKDay   = document.getElementById('vitamin-k-day')?.value || '1';
    const hasPicc   = document.getElementById('picc-line-checkbox')?.checked || false;

    Object.assign(data, { route, naSrc, kSrc, peditFreq, cernFreq, vitKChoice, peditDay, cernDay, vitKDay, hasPicc });
    localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
  }

  function autosaveRestore() {
    const raw = localStorage.getItem(AUTOSAVE_KEY);
    if (!raw) return;
    try {
      const data = JSON.parse(raw);
      Object.entries(data).forEach(([k,v])=>{
        if (['order-date','patient-hn','patient-name','patient-ward','bw','rate','bag','protein','dextrose','fat','milk','total-milk','p','na','k','ca','mg'].includes(k)) {
          const el = document.getElementById(k); if (el) el.value = v;
        }
      });
      if (data.route) document.querySelector(`input[name="tpn-route"][value="${data.route}"]`)?.click();
      if (data.naSrc) document.querySelector(`input[name="na-source"][value="${data.naSrc}"]`)?.click();
      if (data.kSrc)  document.querySelector(`input[name="k-source"][value="${data.kSrc}"]`)?.click();
      if (data.peditFreq) document.querySelector(`input[name="peditrace-freq"][value="${data.peditFreq}"]`)?.click();
      if (data.cernFreq)  document.querySelector(`input[name="cernevit-freq"][value="${data.cernFreq}"]`)?.click();
      if (data.vitKChoice) document.querySelector(`input[name="vitamin-k-choice"][value="${data.vitKChoice}"]`)?.click();

      const pday = document.getElementById('peditrace-day'); if (pday) pday.value = data.peditDay ?? '1';
      const cday = document.getElementById('cernevit-day');  if (cday) cday.value = data.cernDay ?? '1';
      const vday = document.getElementById('vitamin-k-day'); if (vday) vday.value = data.vitKDay ?? '1';

      const picc = document.getElementById('picc-line-checkbox'); if (picc) picc.checked = !!data.hasPicc;
    } catch(e) { }
  }

  function clearAllData() {
    if (!confirm('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
    
    const ids = ['patient-hn','patient-name','patient-ward','bw','rate','bag','protein','dextrose','fat','milk','total-milk','p','na','k','ca','mg'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    
    const dateEl = document.getElementById('order-date');
    if (dateEl) {
      const today = new Date();
      dateEl.value = today.toISOString().split('T')[0];
    }
    
    document.querySelector('input[name="tpn-route"][value="central"]')?.click();
    document.querySelector('input[name="na-source"]')?.checked && (document.querySelector('input[name="na-source"]').checked = false);
    document.querySelector('input[name="k-source"]')?.checked && (document.querySelector('input[name="k-source"]').checked = false);
    document.querySelector('input[name="peditrace-freq"][value="daily"]')?.click();
    document.querySelector('input[name="cernevit-freq"][value="daily"]')?.click();
    document.querySelector('input[name="vitamin-k-choice"][value="none"]')?.click();
    
    const peditDay = document.getElementById('peditrace-day'); if (peditDay) peditDay.value = '1';
    const cernDay = document.getElementById('cernevit-day'); if (cernDay) cernDay.value = '1';
    const vitKDay = document.getElementById('vitamin-k-day'); if (vitKDay) vitKDay.value = '1';
    
    const picc = document.getElementById('picc-line-checkbox'); if (picc) picc.checked = false;
    
    localStorage.removeItem(AUTOSAVE_KEY);
    
    calculateTPN();
    
    alert('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
  }

  // ===== Helpers =====
  function shouldIncludeMicronutrient(freq, selectedDay, orderDate) {
    if (!orderDate) return false;
    const date = new Date(orderDate);
    const dayOfWeek = date.getDay();
    if (freq === 'daily') return true;
    if (freq === 'mwf') return [1,3,5].includes(dayOfWeek);
    if (freq === 'weekly') return dayOfWeek === parseInt(selectedDay);
    return false;
  }

  function getDayName(dateStr) {
    const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const d = new Date(dateStr);
    return days[d.getDay()];
  }

  function r1(v){ 
    if(!isFinite(v)||v===0) return 0; 
    const h=Math.floor(v*100); 
    const d2=h%10; 
    return d2===9? Math.ceil(v*10)/10 : Math.floor(v*10)/10; 
  }
  
  function r2(v){ 
    if(!isFinite(v)||v===0) return 0; 
    const h=Math.floor(v*1000); 
    const d3=h%10; 
    return d3===9? Math.ceil(v*100)/100 : Math.floor(v*100)/100; 
  }
  
  function r0(v){ 
    if(!isFinite(v)||v===0) return 0; 
    const m=v*10; 
    const d1=Math.floor(m)%10; 
    return d1===9? Math.ceil(v) : Math.floor(v); 
  }

  function calculateTPN(){
    const bw = parseFloat(document.getElementById('bw').value) || 0;
    const rate = parseFloat(document.getElementById('rate').value) || 0;
    const bag = parseFloat(document.getElementById('bag').value) || 0;
    const protein = parseFloat(document.getElementById('protein').value) || 0;
    const dextrose = parseFloat(document.getElementById('dextrose').value) || 0;
    const fat = parseFloat(document.getElementById('fat').value) || 0;
    const milk = parseFloat(document.getElementById('milk').value) || 0;
    const totalMilk = parseFloat(document.getElementById('total-milk').value) || (milk*8);
    const p = parseFloat(document.getElementById('p').value) || 0;
    const na = parseFloat(document.getElementById('na').value) || 0;
    const k = parseFloat(document.getElementById('k').value) || 0;
    const ca = parseFloat(document.getElementById('ca').value) || 0;
    const mg = parseFloat(document.getElementById('mg').value) || 0;

    const orderDate = document.getElementById('order-date').value;

    const proteinVol_raw = (bw*protein*100)/10;
    const proteinCal_raw = bw*protein*4;
    const proteinOsm_raw = bag>0 ? (protein*bw*1000*10)/bag : 0;

    const dextroseVol_raw = ((dextrose*bag)/100)*2;
    const dextroseCal_raw = (dextrose*bag*3.4)/100;
    const dextroseOsm_raw = bag>0 ? (dextrose*1000*5)/100 : 0;

    const gir_raw = (bw>0) ? (dextrose*rate)/(6*bw) : 0;

    const fatVol_1 = r1(fat*bw*5);
    const fatCal_raw = fat*bw*10;

    const tfMilk_raw = (bw>0) ? totalMilk/bw : 0;

    const pVol_1 = r1(p*bw);
    const naFromGly = pVol_1*2;
    const naReq_raw = na*bw;
    const rNa_raw = Math.max(0, naReq_raw - naFromGly);

    const naclVol_1 = rNa_raw>0 ? r1(rNa_raw/0.5) : 0;
    const naAcVol_1 = rNa_raw>0 ? r1(rNa_raw/3.0) : 0;

    const totalK_raw = k*bw;
    const kclVol_1 = totalK_raw>0 ? r1(totalK_raw/2.0) : 0;
    const kAcVol_1 = totalK_raw>0 ? r1(totalK_raw/3.0) : 0;

    const caVol_1 = r1((ca*bw)/0.25);
    const mgVol_2 = r2((mg*bw)/2.0);

    const peditFreq = document.querySelector('input[name="peditrace-freq"]:checked')?.value || 'daily';
    const peditDay = document.getElementById('peditrace-day')?.value || '1';
    const includePeditrace = shouldIncludeMicronutrient(peditFreq, peditDay, orderDate);

    const cernFreq = document.querySelector('input[name="cernevit-freq"]:checked')?.value || 'daily';
    const cernDay = document.getElementById('cernevit-day')?.value || '1';
    const includeCernevit = shouldIncludeMicronutrient(cernFreq, cernDay, orderDate);

    let pedit_raw = 1*bw; let peditExceeded=false; if(pedit_raw>10){ pedit_raw=10; peditExceeded=true; }
    const pedit_1 = includePeditrace ? r1(pedit_raw) : 0;

    let cern_raw = 1*bw; let cernExceeded=false; if(cern_raw>3){ cern_raw=3; cernExceeded=true; }
    const cern_1 = includeCernevit ? r1(cern_raw) : 0;

    const vitK_day_raw_calc = (10*bw/1000)*0.5;
    let vitK_day_raw = vitK_day_raw_calc;
    let vitKExceeded = false;
    if(vitK_day_raw > 0.5){ vitK_day_raw = 0.5; vitKExceeded = true; }
    const vitK_week_raw = vitK_day_raw*7;

    const vkChoice = document.querySelector('input[name="vitamin-k-choice"]:checked')?.value || 'none';
    const vkDay = document.getElementById('vitamin-k-day')?.value || '1';
    let includeVitaminK = false;
    if(vkChoice === 'daily') includeVitaminK = true;
    else if(vkChoice === 'weekly') includeVitaminK = shouldIncludeMicronutrient('weekly', vkDay, orderDate);

    const picc = document.getElementById('picc-line-checkbox')?.checked || false;
    const hep_calc_1 = r1(bag>0 ? bag/50 : 0);
    const hep_disp_1 = picc ? hep_calc_1 : 0;

    let totalUsed = 0;
    totalUsed += proteinVol_raw;
    totalUsed += dextroseVol_raw;
    totalUsed += pVol_1;
    totalUsed += caVol_1;
    totalUsed += mgVol_2;
    totalUsed += pedit_1;
    totalUsed += cern_1;
    totalUsed += hep_disp_1;

    const naSource = document.querySelector('input[name="na-source"]:checked')?.value;
    if(naSource === 'nacl') totalUsed += naclVol_1;
    if(naSource === 'na-acetate') totalUsed += naAcVol_1;

    const kSource = document.querySelector('input[name="k-source"]:checked')?.value;
    if(kSource === 'kcl') totalUsed += kclVol_1;
    if(kSource === 'k-acetate') totalUsed += kAcVol_1;

    if(includeVitaminK) {
      if(vkChoice==='daily') totalUsed += vitK_day_raw;
      else if(vkChoice==='weekly') totalUsed += vitK_week_raw;
    }

    const swVol = Math.floor(bag - totalUsed);

    const elyteOsm_raw = bag>0 ? ((na+k)*bw*2*1000)/bag : 0;
    const totalOsm_raw = proteinOsm_raw + dextroseOsm_raw + elyteOsm_raw;

    const pnCalDay = proteinCal_raw + dextroseCal_raw + fatCal_raw;
    const pnCalKg = bw>0 ? pnCalDay/bw : 0;
    const milkCalDay = totalMilk*20/30;
    const milkCalKg = bw>0 ? milkCalDay/bw : 0;
    const totalCalDay = pnCalDay + milkCalDay;

    const dispPN = r0(pnCalKg);
    const dispMilk = r0(milkCalKg);
    const dispTotalKg = dispPN + dispMilk;

    document.getElementById('protein-volume').textContent = r1(proteinVol_raw).toFixed(1);
    document.getElementById('protein-calories').textContent = r1(proteinCal_raw).toFixed(1);
    document.getElementById('protein-osmol').textContent = r1(proteinOsm_raw).toFixed(1);

    document.getElementById('dextrose-volume').textContent = r1(dextroseVol_raw).toFixed(1);
    document.getElementById('dextrose-calories').textContent = r1(dextroseCal_raw).toFixed(1);
    document.getElementById('dextrose-osmol').textContent = r1(dextroseOsm_raw).toFixed(1);

    document.getElementById('gir-result').textContent = r1(gir_raw).toFixed(1) + ' mg/kg/min';

    document.getElementById('fat-volume').textContent = fatVol_1.toFixed(1);
    document.getElementById('fat-calories').textContent = r1(fatCal_raw).toFixed(1);

    document.getElementById('tf-from-milk').textContent = r0(tfMilk_raw) + ' ml/kg/day';
    document.getElementById('milk-calories-kg').textContent = dispMilk + ' kcal/kg/day';

    document.getElementById('p-volume').textContent = pVol_1.toFixed(1) + ' ml';
    document.getElementById('na-from-glycophos').textContent = r1(naFromGly).toFixed(1) + ' mEq';
    document.getElementById('nacl-volume').textContent = naclVol_1.toFixed(1) + ' ml';
    document.getElementById('na-acetate-volume').textContent = naAcVol_1.toFixed(1) + ' ml';

    document.getElementById('kcl-volume').textContent = kclVol_1.toFixed(1) + ' ml';
    document.getElementById('k-acetate-volume').textContent = kAcVol_1.toFixed(1) + ' ml';

    document.getElementById('ca-volume').textContent = caVol_1.toFixed(1) + ' ml';
    document.getElementById('mg-volume').textContent = mgVol_2.toFixed(2) + ' ml';

    const pedEl = document.getElementById('peditrace-volume');
    if (!includePeditrace) {
      pedEl.textContent = '0 ml (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)';
      pedEl.style.background = '#fef3c7';
      pedEl.style.color = '#92400e';
      pedEl.style.border = '1px solid #fcd34d';
    } else {
      pedEl.textContent = pedit_1.toFixed(1) + ' ml';
      pedEl.style.background = (peditExceeded ? '#dc2626' : '#dcfce7');
      pedEl.style.color = (peditExceeded ? 'white' : '#166534');
      pedEl.style.border = (peditExceeded ? '1px solid #dc2626' : '1px solid #86efac');
    }

    const cerEl = document.getElementById('cernevit-volume');
    if (!includeCernevit) {
      cerEl.textContent = '0 ml (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)';
      cerEl.style.background = '#fef3c7';
      cerEl.style.color = '#92400e';
      cerEl.style.border = '1px solid #fcd34d';
    } else {
      cerEl.textContent = cern_1.toFixed(1) + ' ml';
      cerEl.style.background = (cernExceeded ? '#dc2626' : '#dcfce7');
      cerEl.style.color = (cernExceeded ? 'white' : '#166534');
      cerEl.style.border = (cernExceeded ? '1px solid #dc2626' : '1px solid #86efac');
    }

    const dailyRadio = document.querySelector('input[name="vitamin-k-choice"][value="daily"]');
    const weeklyRadio = document.querySelector('input[name="vitamin-k-choice"][value="weekly"]');
    const dailyLabel = dailyRadio?.parentElement;
    const weeklyLabel = weeklyRadio?.parentElement;
    const dailyEl = document.getElementById('vitamin-k-daily');
    const weeklyEl = document.getElementById('vitamin-k-weekly');

    if(vitK_day_raw < 0.01){
      dailyEl.textContent = vitK_day_raw.toFixed(3) + ' ml (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)';
      dailyEl.style.background = '#fef3c7';
      dailyEl.style.color = '#92400e';
      dailyEl.style.border = '1px solid #fcd34d';
      if(dailyRadio){ dailyRadio.disabled=true; if(dailyLabel){ dailyLabel.style.opacity='0.5'; dailyLabel.style.cursor='not-allowed'; } }
      if(dailyRadio && weeklyRadio && dailyRadio.checked) weeklyRadio.checked = true;
    } else {
      dailyEl.textContent = vitK_day_raw.toFixed(3) + ' ml';
      dailyEl.style.background = (vitKExceeded ? '#dc2626' : '#dbeafe');
      dailyEl.style.color = (vitKExceeded ? 'white' : '#1e40af');
      dailyEl.style.border = (vitKExceeded ? '1px solid #dc2626' : '1px solid #bfdbfe');
      if(dailyRadio){ dailyRadio.disabled=false; if(dailyLabel){ dailyLabel.style.opacity='1'; dailyLabel.style.cursor='pointer'; } }
    }
    weeklyEl.textContent = vitK_week_raw.toFixed(3) + ' ml';
    weeklyEl.style.background = '#dbeafe';
    weeklyEl.style.color = '#1e40af';
    weeklyEl.style.border = '1px solid #bfdbfe';

    document.getElementById('heparin-volume').textContent = hep_disp_1.toFixed(1) + ' ml';

    document.getElementById('sterile-water-volume').textContent = swVol;
    const swSec = document.getElementById('sterile-water-section');
    swSec.style.background = swVol<0 ? 'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)'
                                     : 'linear-gradient(135deg,#06b6d4 0%,#0891b2 100%)';

    document.getElementById('total-osmol').textContent = '~' + r0(totalOsm_raw);
    const osmolSec = document.getElementById('osmol-section');
    osmolSec.style.background = r0(totalOsm_raw) > 900 ? 'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)'
                                                       : 'linear-gradient(135deg,#10b981 0%,#059669 100%)';

    document.getElementById('total-calories-day').textContent = r0(totalCalDay);
    document.getElementById('total-calories-kg').textContent = dispTotalKg;
    document.getElementById('breakdown-pn').textContent = dispPN;
    document.getElementById('breakdown-milk').textContent = dispMilk;
    document.getElementById('breakdown-total').textContent = dispTotalKg;

    autosaveCollect();
  }

  function extractNumberString(text) {
    if (text === undefined || text === null) return '0';
    const s = String(text);
    const m = s.match(/-?\d+(\.\d+)?/);
    return m ? m[0] : '0';
  }

  document.addEventListener('DOMContentLoaded', function() {
    const dateEl = document.getElementById('order-date');
    if (dateEl && !dateEl.value) {
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      dateEl.value = dateStr;
    }

    autosaveRestore();

    const setSelectorDisplay = () => {
      const pf = document.querySelector('input[name="peditrace-freq"]:checked')?.value || 'daily';
      document.getElementById('peditrace-day-selector').style.display = (pf==='weekly') ? 'block' : 'none';
      const cf = document.querySelector('input[name="cernevit-freq"]:checked')?.value || 'daily';
      document.getElementById('cernevit-day-selector').style.display = (cf==='weekly') ? 'block' : 'none';
      const vk = document.querySelector('input[name="vitamin-k-choice"]:checked')?.value || 'none';
      document.getElementById('vitamin-k-day-selector').style.display = (vk==='weekly') ? 'block' : 'none';
    };
    setSelectorDisplay();

    document.getElementById('clearBtn')?.addEventListener('click', clearAllData);

    ['bw','rate','bag','protein','dextrose','fat','p','na','k','ca','mg','order-date'].forEach(id=>{
      const el=document.getElementById(id);
      if(el){ el.addEventListener('input', ()=>{ calculateTPN(); }); }
    });

    const milkEl=document.getElementById('milk');
    if(milkEl){
      milkEl.addEventListener('input', function(){
        const milk=parseFloat(this.value)||0;
        const t=document.getElementById('total-milk');
        if(t) t.value=(milk*8).toFixed(0);
        calculateTPN();
      });
    }
    const totMilkEl=document.getElementById('total-milk');
    if(totMilkEl){ totMilkEl.addEventListener('input', ()=>{ calculateTPN(); }); }

    document.querySelectorAll('input[name="na-source"]').forEach(r=>r.addEventListener('change', ()=>{ calculateTPN(); }));
    document.querySelectorAll('input[name="k-source"]').forEach(r=>r.addEventListener('change', ()=>{ calculateTPN(); }));
    const picc = document.getElementById('picc-line-checkbox');
    if(picc){ picc.addEventListener('change', ()=>{ calculateTPN(); }); }

    document.querySelectorAll('input[name="peditrace-freq"]').forEach(r=>{
      r.addEventListener('change', function(){
        document.getElementById('peditrace-day-selector').style.display = this.value==='weekly' ? 'block' : 'none';
        calculateTPN();
      });
    });
    document.querySelectorAll('input[name="cernevit-freq"]').forEach(r=>{
      r.addEventListener('change', function(){
        document.getElementById('cernevit-day-selector').style.display = this.value==='weekly' ? 'block' : 'none';
        calculateTPN();
      });
    });
    document.querySelectorAll('input[name="vitamin-k-choice"]').forEach(r=>{
      r.addEventListener('change', function(){
        document.getElementById('vitamin-k-day-selector').style.display = this.value==='weekly' ? 'block' : 'none';
        calculateTPN();
      });
    });

    document.getElementById('peditrace-day')?.addEventListener('change', ()=>{ calculateTPN(); });
    document.getElementById('cernevit-day')?.addEventListener('change', ()=>{ calculateTPN(); });
    document.getElementById('vitamin-k-day')?.addEventListener('change', ()=>{ calculateTPN(); });

    calculateTPN();
  });

  document.getElementById('submitBtn')?.addEventListener('click', function() {
    const hn = document.getElementById('patient-hn')?.value.trim();
    const name = document.getElementById('patient-name')?.value.trim();
    const ward = document.getElementById('patient-ward')?.value.trim();
    const bw = document.getElementById('bw')?.value;
    const orderDate = document.getElementById('order-date')?.value;

    if (!hn || !name || !ward || !bw || !orderDate) {
      alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
      return;
    }

    const dayName = getDayName(orderDate);
    const dsel = id => document.getElementById(id)?.textContent || document.getElementById(id)?.value || '';

    const reportData = {
      orderDate,
      orderDayName: dayName,
      route: document.querySelector('input[name="tpn-route"]:checked')?.value || 'central',
      hn, name, ward, bw,
      rate: document.getElementById('rate')?.value || '0',
      bag: document.getElementById('bag')?.value || '0',
      protein: document.getElementById('protein')?.value || '0',
      dextrose: document.getElementById('dextrose')?.value || '0',
      fat: document.getElementById('fat')?.value || '0',
      milk: document.getElementById('milk')?.value || '0',
      totalMilk: document.getElementById('total-milk')?.value || '0',
      p: document.getElementById('p')?.value || '0',
      na: document.getElementById('na')?.value || '0',
      k: document.getElementById('k')?.value || '0',
      ca: document.getElementById('ca')?.value || '0',
      mg: document.getElementById('mg')?.value || '0',

      proteinVol: extractNumberString(dsel('protein-volume')),
      proteinCal: extractNumberString(dsel('protein-calories')),
      dextroseVol: extractNumberString(dsel('dextrose-volume')),
      dextroseCal: extractNumberString(dsel('dextrose-calories')),
      fatVol: extractNumberString(dsel('fat-volume')),
      fatCal: extractNumberString(dsel('fat-calories')),

      gir: dsel('gir-result'),

      pVol: extractNumberString(dsel('p-volume')),
      naFromGly: extractNumberString(dsel('na-from-glycophos')),
      naSource: document.querySelector('input[name="na-source"]:checked')?.value || '',
      naclVol: extractNumberString(dsel('nacl-volume')),
      naAcVol: extractNumberString(dsel('na-acetate-volume')),

      kSource: document.querySelector('input[name="k-source"]:checked')?.value || '',
      kclVol: extractNumberString(dsel('kcl-volume')),
      kAcVol: extractNumberString(dsel('k-acetate-volume')),

      caVol: extractNumberString(dsel('ca-volume')),
      mgVol: extractNumberString(dsel('mg-volume')),

      peditrace: extractNumberString(dsel('peditrace-volume')),
      peditFreq: document.querySelector('input[name="peditrace-freq"]:checked')?.value || 'daily',
      peditDay: document.getElementById('peditrace-day')?.value || '1',

      cernevit: extractNumberString(dsel('cernevit-volume')),
      cernFreq: document.querySelector('input[name="cernevit-freq"]:checked')?.value || 'daily',
      cernDay: document.getElementById('cernevit-day')?.value || '1',

      vitKChoice: document.querySelector('input[name="vitamin-k-choice"]:checked')?.value || 'none',
      vitKDay: document.getElementById('vitamin-k-day')?.value || '1',
      vitKDaily: extractNumberString(dsel('vitamin-k-daily')),
      vitKWeekly: extractNumberString(dsel('vitamin-k-weekly')),

      hasPicc: document.getElementById('picc-line-checkbox')?.checked || false,
      heparinVol: extractNumberString(dsel('heparin-volume')),

      sterileWater: extractNumberString(dsel('sterile-water-volume')),
      totalOsmol: extractNumberString(dsel('total-osmol')),

      totalCalDay: extractNumberString(dsel('total-calories-day')),
      totalCalKg: extractNumberString(dsel('total-calories-kg')),
      pnCalKg: extractNumberString(dsel('breakdown-pn')),
      milkCalKg: extractNumberString(dsel('breakdown-milk')),
      tfFromMilk: dsel('tf-from-milk')
    };

    localStorage.setItem('tpnReportData', JSON.stringify(reportData));
    autosaveCollect();
    window.location.href = 'report.html';
  });
</script>
</body>
</html>
